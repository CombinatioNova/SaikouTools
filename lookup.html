<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0 viewport-fit=cover" />
    <title>Saikou | User Lookup</title>
    <meta name="description"
        content="A tool for moderators to look up Roblox user information and Saikou ban status." />
    <link rel="icon" type="image/png" href="https://saikou.dev/assets/images/favicon.png"
        onerror="this.onerror=null;this.href='https://placehold.co/32x32/121315/FFFFFF?text=S'" />
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://saikou.dev/tools/lookup/" />
    <meta property="og:title" content="Saikou | User Lookup" />
    <meta property="og:description" content="Look up Roblox user information and ban status" />
    <meta property="og:image" content="https://saikou.dev/assets/images/og-image.png" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://saikou.dev/tools/lookup/" />
    <meta property="twitter:title" content="Saikou | User Lookup" />
    <meta property="twitter:description" content="Look up Roblox user information and ban status" />
    <meta property="twitter:image" content="https://saikou.dev/assets/images/og-image.png" />

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
        xintegrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --bg-color: #121315;
            --surface-color: #15171c;
            --card-color: #1f222c;
            --border-color: #353a4a;
            --text-primary: #ffffff;
            --text-secondary: #9ca3af;
            --accent-color: #3b82f6;
            --safe-color: #10b981;
            --caution-color: #f59e0b;
            --unsafe-color: #ef4444;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #121315;
            color: white;
            transition: background-image 0.5s ease-in-out;
        }

        input {
            background-color: #1f222c;
            border: 1px solid #353a4a;
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: border-color 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #7f89ff;
        }

        .custom-button {
            font-weight: bold;
            border-radius: 0.5rem;
            color: #121315;
            background-color: #ffffff;
            padding: 0.75rem 1.5rem;
            opacity: 1;
            transition: opacity 0.3s ease;
            cursor: pointer;
        }

        .custom-button:hover:not(:disabled) {
            opacity: 0.8;
        }

        .custom-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stat-card {
            background-color: #1f222c;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .ban-history-table th,
        .ban-history-table td {
            padding: 0.75rem 1rem;
            text-align: left;
        }

        .ban-history-table thead {
            background-color: #1f222c;
        }

        .ban-history-table tbody tr:nth-child(odd) {
            background-color: #1A1C24;
        }

        .friends-grid-container {
            transition: max-height 0.5s ease-in-out;
        }

        .friends-grid-container.collapsed {
            max-height: 220px;
            /* Adjust to fit ~2 rows of friend cards */
            overflow: hidden;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
        }

        .modal-overlay.flex {
            display: flex;
        }

        .modal-content {
            background-color: #1f222c;
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
            border: 1px solid #353a4a;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .modal-content textarea {
            resize: vertical;
            min-height: 80px;
        }

        .detail-label {
            @apply text-xs font-semibold text-gray-400 uppercase tracking-wider;
        }

        .detail-value {
            @apply text-sm text-white bg-gray-700/50 p-2 rounded;
        }

        .detail-reason {
            @apply text-sm text-white bg-gray-700/50 p-2 rounded whitespace-pre-wrap break-words;
        }

        .actions-menu {
            position: absolute;
            top: 100%;
            right: 0;
            z-index: 10;
        }

        /* --- Person of Interest Theming --- */
        @keyframes pulse-danger {

            0%,
            100% {
                box-shadow: 0 0 25px rgba(220, 38, 38, 0.2);
                border-color: rgba(220, 38, 38, 0.4);
            }

            50% {
                box-shadow: 0 0 35px rgba(220, 38, 38, 0.4);
                border-color: rgba(220, 38, 38, 0.6);
            }
        }

        .poi-background {
            background-image: repeating-linear-gradient(45deg, rgba(140, 26, 26, 0.15), rgba(140, 26, 26, 0.15) 15px, transparent 15px, transparent 30px);
            background-attachment: fixed;
        }

        .poi-alert-card {
            background-color: rgba(153, 27, 27, 0.2);
            border: 1px solid rgba(220, 38, 38, 0.4);
            border-radius: 0.5rem;
            padding: 1.5rem;
            animation: pulse-danger 2.5s infinite;
        }

        .poi-profile-container {
            border: 1px solid rgba(220, 38, 38, 0.3);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.15);
        }

        /* --- Ring Indicator Styling --- */
        .ring-indicator {
            background-color: #ef4444;
            color: white;
            border: 2px solid #1f222c;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            transition: all 0.2s ease;
        }

        .ring-indicator:hover {
            background-color: #dc2626;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
        }

        .ring-details-btn:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }

        /* --- Ring Details Modal Styling --- */
        .modal-content.max-w-2xl {
            max-width: 42rem;
        }

        #ring-members-list::-webkit-scrollbar {
            width: 6px;
        }

        #ring-members-list::-webkit-scrollbar-track {
            background: rgba(75, 85, 99, 0.3);
            border-radius: 3px;
        }

        #ring-members-list::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.5);
            border-radius: 3px;
        }

        #ring-members-list::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.7);
        }

        /* Form Validation Styles */
        .form-field-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.3) !important;
        }

        .form-field-success {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.3) !important;
        }

        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            transition: all 0.2s ease;
        }

        .validation-message.error {
            color: #fca5a5;
        }

        .validation-message.success {
            color: #6ee7b7;
        }

        .char-counter {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }

        .char-counter.warning {
            color: #fbbf24;
        }

        .char-counter.error {
            color: #fca5a5;
        }

        /* Enhanced Score Gauge */
        .score-gauge-container {
            position: relative;
            width: 220px;
            height: 120px;
            overflow: hidden;
            margin: 0 auto;
            padding: 20px;
        }

        .score-gauge-bg, .score-gauge-fill {
            position: absolute;
            top: 20px; left: 20px;
            width: 180px; height: 180px;
            border-radius: 50%;
            border: 24px solid;
            box-sizing: border-box;
            clip-path: polygon(0% 0%, 100% 0%, 100% 53%, 0% 53%);
        }

        .score-gauge-bg {
            border-color: var(--border-color);
            opacity: 0.3;
        }
        
        .score-gauge-fill {
            border-color: var(--safe-color);
            transition: transform 1.5s cubic-bezier(0.65, 0, 0.35, 1);
            transform: rotate(0deg);
        }
        
        .score-text {
            position: absolute;
            bottom: 12px;
            top: 50%; /* Try 55-60% for lower placement */
  left: 0;
            right: 0;
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 4px;
        }

        .score-gauge-container.unsafe .score-gauge-fill {
            border-color: var(--unsafe-color);
        }

        .score-gauge-container.caution .score-gauge-fill {
            border-color: var(--caution-color);
        }

        /* Enhanced Risk factor item */
        .risk-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
        }
        .risk-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }
        .risk-item-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }
        .risk-item-icon.negative {
            background-color: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
        }
        .risk-item-icon.positive {
            background-color: rgba(16, 185, 129, 0.1);
            color: #6ee7b7;
        }
        .risk-item-content {
            flex-grow: 1;
            min-width: 0;
        }
        .risk-item-weight {
            font-weight: 600;
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            flex-shrink: 0;
        }
        .risk-item-weight.negative {
            background-color: rgba(239, 68, 68, 0.1);
            color: #fca5a5;
        }
        .risk-item-weight.positive {
            background-color: rgba(16, 185, 129, 0.1);
            color: #6ee7b7;
        }
        .risk-details {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            background-color: var(--surface-color);
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-left: 3.5rem;
            margin-top: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            cursor: help;
        }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tooltip::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 1000;
        }
        .tooltip:hover::after,
        .tooltip:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* Loading shimmer */
        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }
        .shimmer {
            position: relative;
            overflow: hidden;
            background-color: #374151;
        }
        .shimmer::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 1.5s infinite;
        }

        /* Risk Assessment Section */
        .risk-assessment-section {
            background-color: #1f222c;
            border: 1px solid #353a4a;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .risk-assessment-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .risk-assessment-toggle {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.25rem;
            transition: color 0.2s;
        }

        .risk-assessment-toggle:hover {
            color: #ffffff;
        }
    </style>
</head>

<body class="bg-[#121315]">
    <!-- Header -->
    <header class="container mx-auto px-4 md:px-0">
        <nav class="max-w-7xl mx-auto my-4 md:my-8 p-4 bg-[#0c0d0e] rounded-lg flex items-center justify-between">
            <a class="flex items-center" href="/index.html">
                <span id="header-title" class="text-white font-bold text-xl transition-colors duration-300">Saikou
                    Tools</span>
            </a>
            <!-- Auth UI Container -->
            <div>
                <!-- Logged Out View -->
                <div id="login-container">
                    <button id="login-btn" class="custom-button !bg-blue-600 !text-white !px-4 !py-2 text-sm">
                        <i class="fas fa-sign-in-alt mr-2"></i>SDIS Login
                    </button>
                </div>
                <!-- Logged In View -->
                <div id="user-status-container" class="hidden">
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <p id="user-status-name" class="font-bold text-sm text-white">User Name</p>
                            <p id="user-status-role" class="text-xs text-gray-400">SDIS Operative</p>
                        </div>
                        <img id="user-status-avatar" src="" alt="User Avatar"
                            class="w-10 h-10 rounded-full border-2 border-blue-500">
                        <button id="logout-btn" class="custom-button !bg-red-600 !text-white !px-3 !py-1.5 text-xs">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <div class="text-center">
                <h1 class="text-4xl md:text-5xl font-bold">Moderator User Lookup</h1>
                <p class="mt-4 text-lg text-gray-300">Enter a Roblox username or ID to view their profile and ban
                    status.</p>
            </div>

            <div class="mt-10 bg-[#15171c] p-6 sm:p-8 rounded-lg shadow-lg">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="search-input" class="w-full flex-grow"
                        placeholder="Enter Roblox username or ID...">
                    <button id="search-btn" class="custom-button">Search</button>
                </div>
            </div>

            <!-- Result Display -->
            <div id="result-container" class="mt-8">
                <!-- This will be populated with the user profile or a message -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center bg-[#0c0d0e] mt-20 py-12">
        <div class="container mx-auto px-4">
            <p class="text-sm text-gray-500"> 2025, Saikou. All rights reserved.</p>
        </div>
    </footer>

    <!-- POI Modal -->
    <div id="poi-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4 text-white">Mark as Person of Interest</h3>
            <div class="mb-4">
                <label for="poi-name" class="block text-sm font-medium text-gray-300 mb-2">Your Name</label>
                <input type="text" id="poi-name" class="w-full" placeholder="Enter your name" readonly>
            </div>
            <div class="mb-4">
                <label for="poi-reason" class="block text-sm font-medium text-gray-300 mb-2">Reason</label>
                <textarea id="poi-reason"
                    class="w-full bg-[#1f222c] border border-gray-600 text-white rounded px-3 py-2" rows="3"
                    placeholder="Why are you marking this user as a person of interest?"></textarea>
            </div>
            <div class="flex gap-3">
                <button id="poi-cancel-btn"
                    class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">Cancel</button>
                <button id="poi-submit-btn"
                    class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition-colors">Mark as
                    POI</button>
            </div>
        </div>
    </div>

    <!-- POI Details Modal -->
    <div id="poi-details-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4 text-white">Person of Interest Details</h3>
            <div class="space-y-3">
                <div>
                    <p class="detail-label">Marked By</p>
                    <p id="poi-details-marked-by" class="detail-value">Loading...</p>
                </div>
                <div>
                    <p class="detail-label">Reason</p>
                    <p id="poi-details-reason" class="detail-reason">Loading...</p>
                </div>
                <div>
                    <p class="detail-label">Date</p>
                    <p id="poi-details-date" class="detail-value">Loading...</p>
                </div>
            </div>
            <div class="mt-4">
                <button id="poi-details-close-btn"
                    class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="sdis-login-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4 text-white">SDIS Authentication</h3>
            <p class="text-sm text-gray-400 mb-4">Please enter your assigned code phrase to access protected actions.
            </p>
            <div class="mb-4">
                <label for="sdis-code-phrase" class="block text-sm font-medium text-gray-300 mb-2">Code Phrase</label>
                <input type="password" id="sdis-code-phrase" class="w-full" placeholder="Enter your code phrase...">
            </div>
            <div class="flex gap-3">
                <button id="sdis-login-cancel-btn"
                    class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">Cancel</button>
                <button id="sdis-login-submit-btn"
                    class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors">Authenticate</button>
            </div>
        </div>
    </div>

    <!-- Ring Selection Modal -->
    <div id="ring-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="ring-selection-title" class="text-lg font-bold mb-4 text-white">Select Ring</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-2">Available Rings</label>
                <div id="ring-selection-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Ring options will be populated here -->
                </div>
            </div>
            <div class="flex gap-3">
                <button id="ring-selection-cancel-btn"
                    class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">Cancel</button>
                <button id="ring-selection-submit-btn"
                    class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Create Ring Modal -->
    <div id="create-ring-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4 text-white">Create New Ring</h3>
            <div class="mb-4">
                <label for="ring-name" class="block text-sm font-medium text-gray-300 mb-2">Ring Name</label>
                <input type="text" id="ring-name" class="w-full" placeholder="Enter ring name..." maxlength="50">
                <div id="ring-name-error" class="text-red-400 text-xs mt-1 hidden"></div>
                <div class="text-xs text-gray-500 mt-1">3-50 characters, letters, numbers, spaces, hyphens, underscores, and periods only</div>
            </div>
            <div class="mb-4">
                <label for="ring-description" class="block text-sm font-medium text-gray-300 mb-2">Description (Optional)</label>
                <textarea id="ring-description"
                    class="w-full bg-[#1f222c] border border-gray-600 text-white rounded px-3 py-2" rows="3"
                    placeholder="Describe this ring..." maxlength="200"></textarea>
                <div id="ring-description-error" class="text-red-400 text-xs mt-1 hidden"></div>
                <div class="text-xs text-gray-500 mt-1"><span id="description-char-count">0</span>/200 characters</div>
            </div>
            <div class="mb-4">
                <label class="flex items-center gap-2 text-sm text-gray-300">
                    <input type="checkbox" id="add-current-user" checked class="rounded">
                    Add current user to this ring
                </label>
            </div>
            <div class="flex gap-3">
                <button id="create-ring-cancel-btn"
                    class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded transition-colors">Cancel</button>
                <button id="create-ring-submit-btn"
                    class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition-colors">Create Ring</button>
            </div>
        </div>
    </div>

    <!-- Ring Details Modal -->
    <div id="ring-details-modal" class="modal-overlay">
        <div class="modal-content max-w-4xl">
            <div class="flex items-center justify-between mb-4">
                <h3 id="ring-details-title" class="text-lg font-bold text-white">Ring Details</h3>
                <button id="ring-details-close-btn" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-4">
                <!-- Ring Info -->
                <div class="bg-red-900/20 border border-red-700/40 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 id="ring-details-name" class="font-semibold text-red-200 text-lg">Ring Name</h4>
                        <div class="flex items-center gap-2">
                            <span id="ring-details-member-count" class="text-xs text-red-400 bg-red-800/30 px-2 py-1 rounded">0 members</span>
                            <span id="ring-details-status" class="text-xs text-green-400 bg-green-800/30 px-2 py-1 rounded">Active</span>
                        </div>
                    </div>
                    <p id="ring-details-description" class="text-sm text-gray-300 mb-3">Ring description will appear here</p>

                    <!-- Ring Metadata -->
                    <div class="grid grid-cols-2 gap-4 text-xs text-gray-400 pt-3 border-t border-red-700/30">
                        <div>
                            <span class="block font-semibold">Created By:</span>
                            <span id="ring-details-created-by">Unknown</span>
                        </div>
                        <div>
                            <span class="block font-semibold">Created Date:</span>
                            <span id="ring-details-created-date">Unknown</span>
                        </div>
                        <div>
                            <span class="block font-semibold">Last Updated:</span>
                            <span id="ring-details-updated-date">Unknown</span>
                        </div>
                        <div>
                            <span class="block font-semibold">Ring ID:</span>
                            <span id="ring-details-id" class="font-mono">Unknown</span>
                        </div>
                    </div>
                </div>

                <!-- Ring Statistics -->
                <div class="bg-gray-800/30 border border-gray-700 rounded-lg p-4">
                    <h5 class="font-semibold text-white mb-3">Ring Statistics</h5>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="bg-gray-700/30 rounded p-3">
                            <div id="ring-stats-total-members" class="text-xl font-bold text-white">0</div>
                            <div class="text-xs text-gray-400">Total Members</div>
                        </div>
                        <div class="bg-gray-700/30 rounded p-3">
                            <div id="ring-stats-active-members" class="text-xl font-bold text-green-400">0</div>
                            <div class="text-xs text-gray-400">Active Members</div>
                        </div>
                        <div class="bg-gray-700/30 rounded p-3">
                            <div id="ring-stats-recent-activity" class="text-xl font-bold text-blue-400">0</div>
                            <div class="text-xs text-gray-400">Recent Activity</div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Ring Members List -->
                <div class="bg-gray-800/30 border border-gray-700 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h5 class="font-semibold text-white">Ring Members</h5>
                        <div class="flex items-center gap-2">
                            <input type="text" id="member-search" placeholder="Search members..." 
                                   class="text-xs bg-gray-700 border border-gray-600 text-white rounded px-2 py-1 w-32">
                            <button id="refresh-members-btn" class="text-gray-400 hover:text-white transition-colors text-xs">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Enhanced Member Cards Grid -->
                    <div id="ring-members-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto">
                        <!-- Members will be populated here with enhanced cards -->
                    </div>

                    <div id="ring-members-pagination" class="flex items-center justify-between mt-4 pt-3 border-t border-gray-700">
                        <span id="ring-members-info" class="text-xs text-gray-400">Showing 0 of 0 members</span>
                        <div class="flex items-center gap-2">
                            <button id="ring-members-prev" class="text-xs px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded disabled:opacity-50">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <button id="ring-members-next" class="text-xs px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded disabled:opacity-50">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const AUTH_WORKER_URL = 'https://sdis-authenticator.saikoudevelopment.workers.dev';
            const DATA_WORKER_URL = 'https://saikou-ban-proxy.saikoudevelopment.workers.dev';

            // --- DOM Elements ---
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const resultContainer = document.getElementById('result-container');

            // POI Modals
            const poiModal = document.getElementById('poi-modal');
            const poiNameInput = document.getElementById('poi-name');
            const poiReasonInput = document.getElementById('poi-reason');
            const poiCancelBtn = document.getElementById('poi-cancel-btn');
            const poiSubmitBtn = document.getElementById('poi-submit-btn');
            const poiDetailsModal = document.getElementById('poi-details-modal');
            const poiDetailsMarkedBy = document.getElementById('poi-details-marked-by');
            const poiDetailsReason = document.getElementById('poi-details-reason');
            const poiDetailsDate = document.getElementById('poi-details-date');
            const poiDetailsCloseBtn = document.getElementById('poi-details-close-btn');

            // Auth Elements
            const loginContainer = document.getElementById('login-container');
            const loginBtn = document.getElementById('login-btn');
            const userStatusContainer = document.getElementById('user-status-container');
            const userStatusName = document.getElementById('user-status-name');
            const userStatusRole = document.getElementById('user-status-role');
            const userStatusAvatar = document.getElementById('user-status-avatar');
            const logoutBtn = document.getElementById('logout-btn');
            const sdisLoginModal = document.getElementById('sdis-login-modal');
            const sdisCodePhraseInput = document.getElementById('sdis-code-phrase');
            const sdisLoginSubmitBtn = document.getElementById('sdis-login-submit-btn');
            const sdisLoginCancelBtn = document.getElementById('sdis-login-cancel-btn');

            // --- State ---
            let fullFriendsList = [];
            let currentFriendsPage = 1;
            const friendsPerPage = 50;
            let currentLookupData = {};

            // --- Auth State ---
            let authToken = localStorage.getItem('sdis_token');
            let currentUser = null; // Will be populated from localStorage
            let afterLoginCallback = null;

            // Ring validation constants (matching server-side)
            const RING_VALIDATION = {
                NAME_MIN_LENGTH: 3,
                NAME_MAX_LENGTH: 50,
                DESCRIPTION_MAX_LENGTH: 200,
                MAX_MEMBERS_PER_RING: 100,
                MAX_RINGS_PER_SYSTEM: 1000,
                VALID_NAME_PATTERN: /^[a-zA-Z0-9\s\-_.]+$/,
                DEFAULT_COLOR: '#ef4444'
            };

            // --- CIPHER DETECTION FUNCTIONS ---
            function normalizeString(str) {
                return str.toLowerCase().replace(/[\s_-]/g, '');
            }

            function rot(text, shift) {
                return text.replace(/[a-z]/gi, char => {
                    const code = char.charCodeAt(0);
                    if (code >= 65 && code <= 90) { // Uppercase
                        return String.fromCharCode(((code - 65 + shift + 26) % 26) + 65);
                    } else if (code >= 97 && code <= 122) { // Lowercase
                        return String.fromCharCode(((code - 97 + shift + 26) % 26) + 97);
                    }
                    return char;
                });
            }
            
            function atbash(text) {
                return text.replace(/[a-z]/gi, char => {
                    const code = char.charCodeAt(0);
                    if (code >= 65 && code <= 90) { // Uppercase
                        return String.fromCharCode(90 - (code - 65));
                    }
                    if (code >= 97 && code <= 122) { // Lowercase
                        return String.fromCharCode(122 - (code - 97));
                    }
                    return char;
                });
            }
            
            function solveCipher(text) {
                const commonWords = [
                    'the', 'be', 'to', 'of', 'and', 'in', 'that', 'have', 'it', 'for', 'not', 'on', 'with', 'he', 
                    'as', 'you', 'do', 'at', 'this', 'but', 'his', 'by', 'from', 'they', 'we', 'say', 'her', 'she', 
                    'or', 'an', 'will', 'my', 'one', 'all', 'would', 'there', 'their', 'what', 'so', 'up', 'out', 'if', 
                    'about', 'who', 'get', 'which', 'go', 'me', 'when', 'make', 'can', 'like', 'time', 'no', 'just', 
                    'him', 'know', 'take', 'people', 'into', 'year', 'your', 'good', 'some', 'could', 'them', 'see', 
                    'other', 'than', 'then', 'now', 'look', 'only', 'come', 'its', 'over', 'think', 'also', 'back', 
                    'after', 'use', 'two', 'how', 'our', 'work', 'first', 'well', 'way', 'even', 'new', 'want', 
                    'because', 'any', 'these', 'give', 'day', 'most', 'us', 'is', 'are', 'was', 'were', 'has', 'had',
                    'fun', 'play', 'game', 'adventure', 'story', 'fantasy', 'dream', 'night', 'sleep', 'bed', 'room',
                    'house', 'home', 'place', 'space', 'area', 'zone', 'world', 'universe', 'realm', 'dimension',
                    'reality', 'escape', 'hide', 'secret', 'private', 'special', 'unique', 'different', 'wild', 'crazy',
                    'intense', 'deep', 'real', 'genuine', 'authentic', 'true', 'pure', 'raw', 'natural', 'organic', 'fresh', 'age', 'old', 'young'
                    ,'teen', 'teenager', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', 'teenage', ' teen'
                ];
                
                // Suspicious words that might indicate coded content
                const suspiciousWords = [
                    'daddy', 'mommy', 'mami', 'papi', 'bunny', 'kitten', 'puppy', 'baby', 'little', 'princess', 'prince',
                    'master', 'slave', 'sub', 'dom', 'pet', 'brat', 'goth', 'emo', 'winx', 'spade', 'bull', 'horse',
                    'pawg', 'snowbunny', 'jungle', 'rice', 'asian', 'latino', 'dark', 'chocolate', 'vanilla', 'milky',
                    'caramel', 'honey', 'cinnamon', 'spice', 'exotic', 'foreign', 'ebony', 'feet', 'foot', 'toes',
                    'bondage', 'restraint', 'rope', 'chains', 'cuffs', 'gag', 'blindfold', 'whip', 'spank', 'spanking',
                    'leather', 'latex', 'rubber', 'vinyl', 'pvc', 'corset', 'bustier', 'lingerie', 'stockings',
                    'watersports', 'golden', 'yellow', 'pee', 'urine', 'scat', 'brown', 'toilet', 'voyeur', 'exhibition',
                    'public', 'outdoor', 'risky', 'dangerous', 'taboo', 'incest', 'family', 'step', 'brother', 'sister',
                    'teacher', 'student', 'boss', 'employee', 'doctor', 'patient', 'nurse', 'cop', 'officer', 'rod'
                ];
                
                let bestGuess = { type: 'Unknown', text: text, score: 0 };

                const calculateScore = (decodedText, cipherType) => {
                    const words = decodedText.split(/\s+/);
                    const totalWords = words.length;
                    if (totalWords < 2) return 0; // Need at least 2 words to be meaningful
                    
                    const commonWordCount = words.filter(word => {
                        const cleanWord = word.toLowerCase().replace(/[.,!?;:"'()]/g, '');
                        return commonWords.includes(cleanWord);
                    }).length;
                    // Extra helper to check for year-like endings or pure numbers
                    const isLikelyYearOrJustNumber = word => {
                    // Matches 1900-2099 or any 4+ digit number
                    return /^(\d{4})$/.test(word) && +word >= 1900 && +word <= 2099 || /^\d+$/.test(word);
                    };
                    const isLikelyUsername = word => {
                        // alpha then 4-digit year or alpha+digits 3+ or ends with 1900-2099
                        return /^[a-z]+[0-9]{3,}$/.test(word) || /^[a-z]+(19|20)\d{2}$/i.test(word);
                    };
                    // Now in calculateScore:
                    const suspiciousWordCount = words.filter(word => {
                        const cleanWord = word.toLowerCase().replace(/[.,!?;:"'()]/g, '');
                        // Skip likely years, numbers, AND usernames
                        if (isLikelyYearOrJustNumber(cleanWord) || isLikelyUsername(cleanWord)) return false;
                        return suspiciousWords.includes(cleanWord);
                    }).length;
                    
                    // Calculate percentage of common words
                    const commonWordPercentage = commonWordCount / totalWords;
                    const suspiciousWordPercentage = suspiciousWordCount / totalWords;
                    
                    // Only consider it a valid cipher if:
                    // 1. At least 20% of words are common words, OR
                    // 2. At least 1 suspicious word is found, AND
                    // 3. The original text doesn't already have a high percentage of common words
                    const originalWords = text.split(/\s+/);
                    const originalCommonWords = originalWords.filter(word => {
                        const cleanWord = word.toLowerCase().replace(/[.,!?;:"'()]/g, '');
                        return commonWords.includes(cleanWord);
                    }).length;
                    const originalCommonPercentage = originalCommonWords / originalWords.length;
                    
                    // If original text already has high common word percentage, it's likely not a cipher
                    if (originalCommonPercentage > 0.5) return 0;
                    
                    if (cipherType === 'Leetspeak') {
                        // Must have leet chars that aren't just years/numbers/usernames
                        const hasRealLeetWord = words.some(w =>
                            /[0134578@!$+|â‚¬Â£Â¥]/.test(w) && !isLikelyYearOrJustNumber(w) && !isLikelyUsername(w)
                        );
                        if (!hasRealLeetWord) return 0;
                    }
                    
                    // Score based on common words and suspicious words
                    let score = 0;
                    if (commonWordPercentage >= 0.2 && commonWordCount >= 2) {
                        score += commonWordCount * 2;
                    }
                    if (suspiciousWordCount > 0) {
                        score += suspiciousWordCount * 5; // Higher weight for suspicious words
                    }
                    
                    return score;
                };

                // Check for character substitution patterns (like leetspeak)
                const leetPatterns = {
                    '0': 'o', '1': 'i', '3': 'e', '4': 'a', '5': 's', '7': 't', '8': 'b', '@': 'a',
                    '!': 'i', '\\$': 's', '\\+': 't', '\\|': 'i', 'â‚¬': 'e', 'Â£': 'l', 'Â¥': 'y'
                };
                const isLikelyYearOrJustNumber = word => {
                    // Matches 1900-2099 or any 4+ digit number
                    return /^(\d{4})$/.test(word) && +word >= 1900 && +word <= 2099 || /^\d+$/.test(word);
                };
                const isLikelyUsername = word => {
                    // alpha then 4-digit year or alpha+digits 3+ or ends with 1900-2099
                    return /^[a-z]+[0-9]{3,}$/.test(word) || /^[a-z]+(19|20)\d{2}$/i.test(word);
                };
                const decodeLeet = (text) => {
                    return text.split(/\s+/).map(word => {
                        // Only decode leet if NOT a year, number, or username
                        if (isLikelyYearOrJustNumber(word) || isLikelyUsername(word)) return word;
                        let decoded = word.toLowerCase();
                        for (const [leet, normal] of Object.entries(leetPatterns)) {
                            decoded = decoded.replace(new RegExp(leet, 'g'), normal);
                        }
                        return decoded;
                    }).join(' ');
                };
                
                
                const leetText = decodeLeet(text);
                const leetScore = calculateScore(leetText, 'Leetspeak');
                // Only treat as leetspeak if leetScore is high enough
                if (leetScore > bestGuess.score && leetScore >= 8) {
                    bestGuess = { type: 'Leetspeak', text: leetText, score: leetScore };
                }

                // Check for reversed text
                const reversedText = text.split('').reverse().join('');
                const reversedScore = calculateScore(reversedText, 'Reversed');
                if (reversedScore > bestGuess.score) {
                    bestGuess = { type: 'Reversed', text: reversedText, score: reversedScore };
                }

                

                const atbashText = atbash(text);
                const atbashScore = calculateScore(atbashText, 'Atbash');
                if (atbashScore > bestGuess.score) {
                    bestGuess = { type: 'Atbash', text: atbashText, score: atbashScore };
                }

                for (let i = 1; i < 26; i++) {
                    const shiftedText = rot(text, i);
                    const score = calculateScore(shiftedText, 'Caesar');
                    if (score > bestGuess.score) {
                        const decryptShift = (26 - i) % 26;
                        bestGuess = { type: `Caesar (ROT-${decryptShift})`, text: shiftedText, score: score };
                    }
                }

                if (bestGuess.score === 0) {
                     bestGuess.type = 'Unknown';
                }
                return bestGuess;
            }

            // --- SAFETY SCORE CALCULATION ---
            function calculateSafetyScore(profile, friends = [], rings = [], bannedFriends = []) {
                let score = 50;
                const reasons = {
                    positive: [],
                    negative: [],
                    decoded: null // For storing decoded cipher text
                };

                const highConfidenceKeywords = [
                    'lewd', 'nsfw', 'sexual', 'solicit', 'ddlg', 'mdlb', 'femdom', 'bdsm', 'kink', 'fetish',
                    'roleplay', 'cyber', 'sexting', 'cam', 'webcam', 'nude', 'naked', 'horny', 'aroused', 'qos', 'femboy', 'femboi','horse','bull','rod','frisk','puppy','puppi','pup','kitten','baby','little','littlespace','ageplay','abdl','diaper','pacifier','sippy','onesie','cgl','cg/l','caregiver','little girl','little boy','princess','prince'
                ];
                const ambiguousKeywords = [
                    'degrade', 'daddy', 'mommy', 'mami', 'papi', 'bunny', 'bunni', 'kitten', 'kitty', 'kitti',
                    'maid', 'adult', '18+', 'sub', 'dom', 'slave', 'master', 'pet', 'spade', 'â™ ', 'ðŸ’¦', 
                    'brat', 'collar', 'leash', 'femboi', 'femboy', 'goth', 'emo', 'winx', 'checkbio',
                    'br3ak', 'b4ck', 'bigbull', 'detonador', 'llenador', 'bathroom', 'pawg', 'readbio', 
                    'bull', 'horse', 'rod', 'frisk', 'puppy', 'puppi', 'pup', 'kitten', 'kitty', 'baby',
                    'little', 'littlespace', 'ageplay', 'abdl', 'diaper', 'pacifier', 'sippy', 'onesie',
                    'cgl', 'cg/l', 'caregiver', 'little girl', 'little boy', 'princess', 'prince', 'erp', 'rp'
                ];
                const solicitationKeywords = [ 
                    'studio', 'private', 'alone', 'vc', 'voice chat', 'dms', 'direct message', 'hangout', 
                    'condo', 'server', 'place', 'cant talk', "can't talk", 'add me on', 'disc', 'discord', 
                    'name says it all', 'dm me', 'message me', 'hit me up', 'slide into', 'snap', 'snapchat',
                    'telegram', 'kik', 'wickr', 'session', 'signal', 'whatsapp', 'contact me', 'reach out'
                ];
                const codedRpKeywords = [ 
                    'top bunk', 'bottom bunk', 'bunk rp', 'dom rp', 'sub rp', 'bed rp', 'sleep rp', 
                    'night rp', 'dream rp', 'fantasy rp', 'adventure rp', 'story rp', 'plot rp',
                    'scenario rp', 'situation rp', 'scene rp', 'act rp', 'play rp', 'game rp'
                ];
                const racialFetishKeywords = [ 
                    'snowbunny', 'snowbun', 'jungle fever', 'rice queen', 'asian persuasion', 'latino', 
                    'asian', 'dark', 'pawg', 'paxwg', 'pxwg', 'ebony', 'chocolate', 'vanilla', 'milky',
                    'caramel', 'honey', 'cinnamon', 'spice', 'exotic', 'foreign', 'import', 'export'
                ];
                const fetishSpecificKeywords = [
                    'feet', 'foot', 'toes', 'soles', 'arches', 'footjob', 'foot worship', 'tickling',
                    'bondage', 'restraint', 'rope', 'chains', 'cuffs', 'gag', 'blindfold', 'whip',
                    'spank', 'spanking', 'paddle', 'crop', 'flogger', 'discipline', 'punishment',
                    'leather', 'latex', 'rubber', 'vinyl', 'pvc', 'corset', 'bustier', 'lingerie',
                    'stockings', 'pantyhose', 'thigh highs', 'garters', 'heels', 'stilettos',
                    'latex', 'leather', 'rubber', 'vinyl', 'pvc', 'corset', 'bustier', 'lingerie',
                    'stockings', 'pantyhose', 'thigh highs', 'garters', 'heels', 'stilettos',
                    'watersports', 'golden', 'yellow', 'pee', 'urine', 'scat', 'brown', 'toilet',
                    'voyeur', 'exhibition', 'public', 'outdoor', 'risky', 'dangerous', 'taboo',
                    'incest', 'family', 'step', 'brother', 'sister', 'father', 'mother', 'uncle', 'aunt',
                    'teacher', 'student', 'boss', 'employee', 'doctor', 'patient', 'nurse', 'cop', 'officer'
                ];
                const codedLanguageKeywords = [
                    'fun', 'play', 'game', 'adventure', 'story', 'fantasy', 'dream', 'night', 'sleep',
                    'bed', 'room', 'house', 'home', 'place', 'space', 'area', 'zone', 'world',
                    'universe', 'realm', 'dimension', 'reality', 'escape', 'hide', 'secret', 'private',
                    'special', 'unique', 'different', 'wild', 'crazy', 'intense', 'deep', 'real',
                    'genuine', 'authentic', 'true', 'pure', 'raw', 'natural', 'organic', 'fresh'
                ];
                const ambiguousBioKeywords = [ 
                    'here for the fun of it', 'just for fun', 'bored', 'he wont know', 'looking for fun',
                    'want to have fun', 'need some fun', 'bored and lonely', 'lonely and bored',
                    'single and ready', 'ready to mingle', 'open minded', 'adventurous', 'spontaneous',
                    'wild side', 'dark side', 'naughty side', 'bad side', 'rebellious', 'mischievous'
                ];
                
                const checkName = (name) => {
                    const normalized = normalizeString(name);
                    const foundHigh = highConfidenceKeywords.filter(kw => normalized.includes(kw));
                    const foundAmbiguous = ambiguousKeywords.filter(kw => normalized === kw);
                    return [...foundHigh, ...foundAmbiguous];
                };

                const nameString = profile.name + " " + profile.displayName;
                const matchedNameKeywords = checkName(nameString);
                
                if (matchedNameKeywords.length > 0) {
                    score -= 40;
                    reasons.negative.push({ text: `Username/display name contains suspicious words`, weight: -40, icon: 'fa-id-card', data: matchedNameKeywords });
                }

                if (profile.description) {
                    let descriptionString = profile.description || "";
                    let textForAnalysis = descriptionString.toLowerCase();
                    let flagObfuscation = false;
                    let reasonsDecoded = null;

                    // Step 1: Check plain English first
                    if (!isPlainEnglish(descriptionString)) {
                        // Step 2: Only run cipher if not plain English
                        const cipherResult = solveCipher(descriptionString);

                        // Step 3: Penalize ONLY if score is high, type is valid, and not whitelisted
                        if (cipherResult.type !== "Unknown" && cipherResult.score >= 3) {
                            score -= 35;
                            flagObfuscation = true;
                            
                            reasonsDecoded = `[${cipherResult.type}] ${cipherResult.text}`;
                            textForAnalysis = cipherResult.text.toLowerCase();
                        }
                        // If cipher is Unknown or <8, leave textForAnalysis as original and don't penalize!
                    }
                    // else { // Is plain English: continue unflagged, do not run cipher }

                    // KEYWORD MATCH/FLAGGING LOGIC
                    const allKeywords = [
                        ...highConfidenceKeywords,
                        ...ambiguousKeywords,
                        ...solicitationKeywords,
                        ...codedRpKeywords,
                        ...racialFetishKeywords,
                        ...fetishSpecificKeywords,
                        ...codedLanguageKeywords,
                        ...ambiguousBioKeywords
                    ];
                    const matchedDescKeywords = allKeywords.filter(kw => {
    // Escape special regex characters in the keyword
    const escapedKw = kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    // Create regex with word boundaries
    const wordBoundaryRegex = new RegExp(`\\b${escapedKw}\\b`, 'i');
    return wordBoundaryRegex.test(textForAnalysis);
})
                    if (matchedDescKeywords.length > 0) {
                        const penalty = flagObfuscation ? 45 : 20;
                        const reasonText = flagObfuscation
                            ? `Decoded message contains suspicious words`
                            : `Profile description contains suspicious words`;
                        score -= penalty;
                        reasons.negative.push({ text: reasonText, weight: -penalty, icon: 'fa-file-alt', data: matchedDescKeywords });
                    }

                    if (/\w+'s\s(game|studio|place|hangout|condo)/.test(textForAnalysis)) {
                        score -= 45;
                        reasons.negative.push({ text: `Soliciting private interactions (euphemism)`, weight: -45, icon: 'fa-user-plus', data: ["studio game"] });
                    }

                    if (/(looking for|want|need|seeking|searching for)\s+(fun|play|game|adventure|story|fantasy|dream|night|sleep|bed|room|house|home|place|space|area|zone|world|universe|realm|dimension|reality|escape|hide|secret|private|special|unique|different|wild|crazy|intense|deep|real|genuine|authentic|true|pure|raw|natural|organic|fresh)/.test(textForAnalysis)) {
                        score -= 30;
                        reasons.negative.push({ text: `Uses coded language for solicitation`, weight: -30, icon: 'fa-user-secret', data: ["coded solicitation"] });
                    }

                    if (/(young|youth|teen|minor|underage|fresh|new|innocent|pure|virgin|first time|beginner|novice|rookie|green|naive|sweet|cute|adorable|precious|little|small|tiny|mini|petite|delicate|fragile|tender|soft|gentle|kind|nice|good|clean|fresh|new|innocent|pure|virgin|first time|beginner|novice|rookie|green|naive|sweet|cute|adorable|precious|little|small|tiny|mini|petite|delicate|fragile|tender|soft|gentle|kind|nice|good|clean)/.test(textForAnalysis)) {
                        score -= 40;
                        reasons.negative.push({ text: `Uses potentially age-related coded language`, weight: -40, icon: 'fa-exclamation-triangle', data: ["age-related coding"] });
                    }

                    

                    const agePattern = /\b(1[3-9]|2\d|30)\b/g;
                    if (agePattern.test(textForAnalysis)) {
                        score -= 35;
                        reasons.negative.push({ text: "Profile description contains a suspicious age declaration.", weight: -35, icon: 'fa-user-tag' });
                    }

                    // Obfuscation reason out here for clarity
                    if (flagObfuscation) {
                        reasons.negative.push({
                            text: `Description uses text obfuscation`,
                            weight: -35,
                            icon: 'fa-user-secret'
                        });
                        reasons.decoded = reasonsDecoded;
                    }
                }
                
                const matchedRacialNameKeywords = racialFetishKeywords.filter(kw => normalizeString(nameString).includes(normalizeString(kw)));
                if (matchedRacialNameKeywords.length > 0) {
                    score -= 50;
                    reasons.negative.push({ text: `Username/display name uses coded racial fetish terminology`, weight: -50, icon: 'fa-globe-americas', data: matchedRacialNameKeywords });
                }

                if (profile.groups && profile.groups.length > 0) {
                    // More targeted group detection - only flag groups with clearly suspicious content
                    const suspiciousGroups = profile.groups.filter(g => {
                        const groupName = g.name.toLowerCase();
                        
                        // Only check for high-confidence and clearly fetish-related keywords
                        const highRiskKeywords = [...highConfidenceKeywords, ...fetishSpecificKeywords, ...racialFetishKeywords];
                        
                        // Remove some ambiguous terms that are too common in normal group names
                        const filteredKeywords = highRiskKeywords.filter(kw => 
                            !['studio', 'game', 'games', 'fun', 'play', 'adventure', 'story', 'fantasy', 'dream', 'night', 'sleep', 'bed', 'room', 'house', 'home', 'place', 'space', 'area', 'zone', 'world', 'universe', 'realm', 'dimension', 'reality', 'escape', 'hide', 'secret', 'private', 'special', 'unique', 'different', 'wild', 'crazy', 'intense', 'deep', 'real', 'genuine', 'authentic', 'true', 'pure', 'raw', 'natural', 'organic', 'fresh'].includes(kw.toLowerCase())
                        );
                        
                        return filteredKeywords.some(kw => {
    // Escape regex special chars in kw, e.g. ( ) . * +
    const escapedKw = kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    // Use word boundary regex to match only whole words
    const regex = new RegExp(`\\b${escapedKw}\\b`, 'i');
    return regex.test(groupName);
});
                    });
                    
                    // Additional group pattern detection - be more specific
                    const patternSuspiciousGroups = profile.groups.filter(g => {
                        const groupName = g.name.toLowerCase();
                        // Only flag if it contains both a location word AND a clearly fetish term
                        const hasLocation = /(farm|barn|house)/.test(groupName);
                        const hasFetishTerm = /(bunny|kitten|puppy|baby|little|princess|prince|daddy|mommy|master|slave|sub|dom|pet|brat|goth|emo|winx|spade|â™ |ðŸ’¦|bull|horse|rod|frisk|pawg|snowbunny|jungle|rice|asian|latino|dark|chocolate|vanilla|milky|caramel|honey|cinnamon|spice|exotic|foreign|import|export|ebony|feet|foot|toes|soles|arches|footjob|foot worship|tickling|bondage|restraint|rope|chains|cuffs|gag|blindfold|whip|spank|spanking|paddle|crop|flogger|discipline|punishment|leather|latex|rubber|vinyl|pvc|corset|bustier|lingerie|stockings|pantyhose|thigh highs|garters|heels|stilettos|watersports|golden|yellow|pee|urine|scat|brown|toilet|voyeur|exhibition|public|outdoor|risky|dangerous|taboo|incest|family|step|brother|sister|father|mother|uncle|aunt|teacher|student|boss|employee|doctor|patient|nurse|cop|officer)/.test(groupName);
                        
                        return hasLocation && hasFetishTerm;
                    });
                    
                    const allSuspiciousGroups = [...new Set([...suspiciousGroups, ...patternSuspiciousGroups])];
                    
                    if (allSuspiciousGroups.length > 0) {
                        const penalty = Math.min(45, allSuspiciousGroups.length * 15);
                        score -= penalty;
                        reasons.negative.push({ text: `Joined ${allSuspiciousGroups.length} group(s) with suspicious names.`, weight: -penalty, icon: 'fa-users-slash', data: allSuspiciousGroups.map(g => g.name) });
                    }
                }
                
                if (profile.outfit && profile.outfit.length > 0) {
                    const suspiciousItems = profile.outfit.filter(item => checkName(item.name).length > 0);
                    if (suspiciousItems.length > 0) {
                        const penalty = Math.min(35, suspiciousItems.length * 10);
                        score -= penalty;
                        const itemNames = suspiciousItems.map(i => i.name);
                        reasons.negative.push({ text: `Wearing ${suspiciousItems.length} suspicious avatar item(s).`, weight: -penalty, icon: 'fa-tshirt', data: itemNames });
                    }
                }
                // Bonus for SDIS membership
                const SDIS_GROUP_ID = 3149674;
                const isSDISMember = profile.groups && profile.groups.some(g => 
                    (g.id && +g.id === SDIS_GROUP_ID) || (g.groupId && +g.groupId === SDIS_GROUP_ID)
                );

                if (isSDISMember) {
                    score += 40;
                    reasons.positive = reasons.positive || [];
                    reasons.positive.push({
                        text: "Member of SDIS (Roblox community bonus)",
                        weight: 40,
                        icon: "fa-star", // or your preferred icon
                        data: [SDIS_GROUP_ID]
                    });
                }
                if (profile.favorites && profile.favorites.length > 0) {
                    const suspiciousFavorites = profile.favorites.filter(game =>
                        checkName(game.name).length > 0 ||
                        solicitationKeywords.some(kw => normalizeString(game.name).includes(normalizeString(kw)))
                    );
                    if (suspiciousFavorites.length > 0) {
                        const penalty = Math.min(50, suspiciousFavorites.length * 25);
                        score -= penalty;
                        reasons.negative.push({ text: `Favorited ${suspiciousFavorites.length} suspicious games.`, weight: -penalty, icon: 'fa-gamepad', data: suspiciousFavorites.map(g => g.name) });
                    }
                }

                if (friends && friends.length > 0) {
                    const suspiciousFriends = friends.filter(friend => checkName(friend.name).length > 0);
                    if (suspiciousFriends.length > 0) {
                        const suspiciousPercent = (suspiciousFriends.length / friends.length) * 100;
                        let penalty = Math.min(25, suspiciousFriends.length * 10);
                        if (suspiciousPercent > 30) {
                             penalty = Math.max(penalty, 50);
                        } else if (suspiciousFriends.length > 1) {
                             penalty = Math.max(penalty, 35);
                        }
                        score -= penalty;
                        reasons.negative.push({ text: `Associates with accounts using suspicious names.`, weight: -penalty, icon: 'fa-users-cog', data: suspiciousFriends.map(f => f.name) });
                    }
                }

                if (profile.isBanned) { score -= 80; reasons.negative.push({ text: "Account is currently banned by Saikou.", weight: -80, icon: 'fa-ban' }); }
                if (profile.isPOI) { score -= 50; reasons.negative.push({ text: "Flagged as a Person of Interest by SDIS.", weight: -50, icon: 'fa-exclamation-triangle' }); }
                if (rings && rings.length > 0) { score -= 60; reasons.negative.push({ text: `Member of ${rings.length} known exploiter ring(s).`, weight: -60, icon: 'fa-link' }); }
                
                if (bannedFriends && bannedFriends.length > 0) {
                    let penalty = Math.min(30, bannedFriends.length * 5);
                    let reasonText = `Has ${bannedFriends.length} friend(s) who are banned.`;
                    if (profile.friendCount > 0 && profile.friendCount > bannedFriends.length) {
                        const bannedPercent = (bannedFriends.length / profile.friendCount) * 100;
                        if (bannedPercent > 20) {
                            penalty = Math.max(penalty, 40);
                            reasonText += ` This indicates a clear pattern of association.`
                        }
                    }
                    score -= penalty;
                    reasons.negative.push({ text: reasonText, weight: -penalty, icon: 'fa-user-slash' });
                }

                // Account age calculation
                let accountAge = 0;
                if (profile.created) {
                    const ageMs = Date.now() - new Date(profile.created).getTime();
                    accountAge = Math.floor(ageMs / (1000 * 60 * 60 * 24)); // days
                }

                if (accountAge < 30) { score -= 30; reasons.negative.push({ text: "Account is very new (less than 30 days old).", weight: -30, icon: 'fa-baby' }); } 
                else if (accountAge < 90) { score -= 15; reasons.negative.push({ text: "Account is new (less than 90 days old).", weight: -15, icon: 'fa-child' }); }
                if (profile.inventoryHidden) { score -= 5; reasons.negative.push({ text: "Inventory is private.", weight: -5, icon: 'fa-eye-slash' }); }
                
                if (profile.friendCount < 10 && profile.followersCount < 10 && profile.followingCount < 10) { score -= 10; reasons.negative.push({ text: "Extremely low social engagement (friends, followers, following).", weight: -10, icon: 'fa-user-friends' }); } 
                else if (profile.friendCount < 10) { score -= 5; reasons.negative.push({ text: "Very low friend count.", weight: -5, icon: 'fa-user-friends' }); }

                // Positive factors
                if (accountAge > 365 * 2) { const bonus = Math.min(20, Math.floor(accountAge / 365) * 2.5); score += bonus; reasons.positive.push({ text: `Veteran user (${Math.floor(accountAge / 365)}+ years old).`, weight: bonus, icon: 'fa-award' }); }
                if (profile.hasVerifiedBadge) { score += 15; reasons.positive.push({ text: "Has a verified badge on Roblox.", weight: 15, icon: 'fa-check-circle' }); }
                if (profile.isPremium) { score += 10; reasons.positive.push({ text: "Has an active Roblox Premium subscription.", weight: 10, icon: 'fa-star' }); }
                if (profile.groupRole) { score += 20; reasons.positive.push({ text: "Holds a staff role in Saikou.", weight: 20, icon: 'fa-shield-alt' }); }
                if (profile.notableBadges && profile.notableBadges.length > 0) { score += 10; reasons.positive.push({ text: `Has ${profile.notableBadges.length} notable Roblox badge(s).`, weight: 10, icon: 'fa-medal' }); }
                if (profile.followersCount > 1000) { const bonus = Math.min(15, Math.floor(profile.followersCount / 1000) * 1); score += bonus; reasons.positive.push({ text: "Has a significant number of followers.", weight: bonus, icon: 'fa-users' }); }

                // Remove duplicate negative reasons
                const uniqueNegative = [];
                const seenNegative = new Set();
                reasons.negative.forEach(r => {
                    const key = r.text;
                    if (!seenNegative.has(key)) {
                        uniqueNegative.push(r);
                        seenNegative.add(key);
                    }
                });
                reasons.negative = uniqueNegative;

                score = Math.max(0, Math.min(100, score));
                
                let rating, color;
                if (score < 30) { rating = "Unsafe"; color = 'unsafe'; } 
                else if (score < 60) { rating = "Caution"; color = 'caution'; } 
                else { rating = "Safe"; color = 'safe'; }

                return { score: Math.round(score), rating, color, reasons };
            }
            function isPlainEnglish(text) {
                return false;
                // Split text into words, check if most are in common English word list
                const commonWords = [
"the","be","to","of","and","a","in","that","have","it","for","not","on","with","he","as","you","do","at",
"this","but","his","by","from","they","we","say","her","she","or","an","will","my","one","all","would","there","their",
"what","so","up","out","if","about","who","get","which","go","me","when","make","can","like","time","no","just","him","know",
"take","people","into","year","your","good","some","could","them","see","other","than","then","now","look","only","come","its","over","think",
"also","back","after","use","two","how","our","work","first","well","way","even","new","want","because","any","these","give","day","most","us",
"is","are","was","were","has","had","fun","play","game","adventure","story","fantasy","dream","night","sleep","bed","room","house","home","place","space",
"area","zone","world","universe","realm","dimension","reality","escape","hide","secret","private","special","unique","different","wild","crazy","intense","deep",
"real","genuine","authentic","true","pure","raw","natural","organic","fresh","see","end","never","always","every","many","few","some","better","worse","best",
"next","last","long","short","high","low","big","small","tall","young","old","early","late","begin","start","stop","finish","again","once","twice","three","four",
"five","six","seven","eight","nine","ten","hundred","thousand","million","billion","today","tomorrow","yesterday","soon","later","before","after","above","below",
"inside","outside","between","among","around","far","near","close","away","toward","against","upon","over","under","beside","beyond","during","while","until","though",
"unless","because","since","if","though","although","yet","however","still","instead","rather","just","right","left","down","across","along","through","without",
"within","where","when","why","who","whom","whose","how","which","what","whether","shall","should","may","might","must","can","could","will","would","do","does",
"did","done","having","being","want","needs","calls","comes","goes","runs","walks","drives","rides","flies","moves","stays","sits","stands","lies","waits",
"hopes","feels","thinks","knows","believes","remembers","forgets","understands","learns","teaches","reads","writes","speaks","listens","sees","hears",
"smells","tastes","touches","holds","grabs","drops","puts","takes","gives","gets","keeps","loses","ends","begins","opens","closes","shows","finds",
"looks","watches","turns","calls","names","asks","answers","tells","tells","talks","speaks","explains","describes","roblox","builder","friends","fun","hangout","chill","gaming","gamer","group","crew","team","family","friend","play","games","game","adventure",
"obby","parkour","roleplay","rp","tycoon","simulator","fan","fans","club","meet","join","visit","welcome","social","party","explore",
"leader","owner","dev","developer","scripter","builder","designer","creator","active","online","offline","newbie","pro","noob","cool","cute","awesome",
"epic","legendary","rich","famous","popular","win","winner","lose","loser","tryhard","casual","skill","skills","funny","meme","memes","joke",
"laugh","vibe","awesome","crazy","wild","random","good","great","amazing","best","love","loving","kind","helpful","carer","safe","trust",
"trusted","respect","support","supporter","member","community","friendship","peace","unity","dream","hope","dreamer","enjoy","happy","smile","party",
"celebrate","event","challenge","quest","mission","buddy","buddies","pal","pals"
];
                const words = text.split(/\s+/);
                const nCommon = words.filter(w => commonWords.includes(w.toLowerCase().replace(/[\.,!?]/g, ""))).length;
                // If >90% words are common English, call it "plain"
                return (nCommon / words.length) > 0.9;
                }
            // --- RISK ASSESSMENT UI RENDERING ---
            function renderRiskAssessment(report) {
                const scoreRotation = (report.score / 100) * 180;
                
                const factorHTML = (factors, color) => {
                    if (factors.length === 0) return `<p class="text-sm text-gray-500 italic">No factors detected</p>`;
                    return factors.sort((a,b) => a.weight - b.weight).map(r => {
                        const isPositive = r.weight > 0;
                        const typeClass = isPositive ? 'positive' : 'negative';
                        const tooltipText = r.data ? `Details: ${r.data.join(', ')}` : `Impact: ${r.weight > 0 ? '+' : ''}${r.weight} points`;
                        
                        return `
                            <div class="risk-item">
                                <div class="risk-item-icon ${typeClass}">
                                    <i class="fas ${r.icon}"></i>
                                </div>
                                <div class="risk-item-content">
                                    <span class="tooltip" data-tooltip="${tooltipText}">${r.text}</span>
                                </div>
                                <div class="risk-item-weight ${typeClass}">
                                    ${r.weight > 0 ? '+' : ''}${r.weight}
                                </div>
                            </div>
                            ${r.data ? `<div class="risk-details">${r.data.slice(0, 3).join(', ')}${r.data.length > 3 ? `... and ${r.data.length - 3} more` : ''}</div>` : ''}
                        `;
                    }).join('');
                };
                
                // Enhanced decoded cipher HTML
                const decodedCipherHTML = report.reasons.decoded ? `
                    <div class="mt-4 bg-yellow-500/10 border border-yellow-500/30 p-4 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-key text-yellow-400"></i>
                            <p class="text-sm font-semibold text-yellow-300 tooltip" data-tooltip="Text obfuscation detected and decoded">Decoded Obfuscated Message:</p>
                        </div>
                        <div class="bg-black/20 border border-yellow-500/20 rounded p-3">
                            <p class="font-mono text-sm text-yellow-200 break-words leading-relaxed">${report.reasons.decoded}</p>
                        </div>
                    </div>` : '';

                return `
                    <div class="mt-6 border-t border-gray-700 pt-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-white flex items-center gap-2">
                                <i class="fas fa-shield-alt text-blue-400"></i>
                                <span class="tooltip" data-tooltip="Automated analysis of user safety based on multiple factors">Risk Assessment</span>
                            </h3>
                            <button class="risk-assessment-toggle group" onclick="toggleRiskAssessment()" title="Toggle risk assessment details">
                                <i class="fas fa-chevron-down transition-transform duration-200 group-hover:scale-110"></i>
                            </button>
                        </div>
                        
                        <div id="risk-assessment-content" class="space-y-6">
                            <div class="flex flex-col lg:flex-row items-center gap-8">
                                <div class="flex flex-col items-center justify-center text-center">
                                    <div class="score-gauge-container ${report.color} mb-4">
                                        <div class="score-gauge-bg"></div>
                                        <div class="score-gauge-fill" style="transform: rotate(${scoreRotation}deg);"></div>
                                        <div class="score-text">
                                            <span class="text-6xl font-bold">${report.score}</span>
                                            <span class="text-xl text-gray-400 font-semibold">/100</span>
                                        </div>
                                    </div>
                                    <h4 class="text-3xl font-bold" style="color: var(--${report.color}-color);">${report.rating}</h4>
                                    <p class="text-gray-400 text-sm tooltip" data-tooltip="Score based on account analysis, associations, and behavior patterns">Overall Safety Score</p>
                                </div>
                                
                                <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div class="space-y-4">
                                        <h5 class="font-bold text-lg text-red-400 flex items-center gap-2">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span class="tooltip" data-tooltip="Factors that decrease the safety score">Risk Factors</span>
                                        </h5>
                                        <div class="space-y-3">
                                            ${factorHTML(report.reasons.negative, 'red')}
                                        </div>
                                        ${decodedCipherHTML}
                                    </div>

                                    <div class="space-y-4">
                                        <h5 class="font-bold text-lg text-green-400 flex items-center gap-2">
                                            <i class="fas fa-shield-check"></i>
                                            <span class="tooltip" data-tooltip="Factors that increase the safety score">Safety Factors</span>
                                        </h5>
                                        <div class="space-y-3">
                                            ${factorHTML(report.reasons.positive, 'green')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function toggleRiskAssessment() {
                const content = document.getElementById('risk-assessment-content');
                const toggle = document.querySelector('.risk-assessment-toggle i');
                if (content && toggle) {
                    content.classList.toggle('hidden');
                    toggle.classList.toggle('fa-chevron-down');
                    toggle.classList.toggle('fa-chevron-up');
                }
            }


            const handleSearch = async (queryOverride) => {
                const query = queryOverride || searchInput.value.trim();
                if (!query) return;

                if (queryOverride) searchInput.value = query;

                document.body.classList.remove('poi-background');
                setLoadingState();
                try {
                    const response = await fetch(`${DATA_WORKER_URL}?lookup=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (!response.ok || !data.success) {
                        throw new Error(data.error || 'An unknown error occurred.');
                    }

                    currentLookupData = data;
                    fullFriendsList = data.friends || [];
                    currentFriendsPage = 1;
                    
                    // Fetch ring data for the user
                    try {
                        const ringResponse = await fetch(`${AUTH_WORKER_URL}/rings`, {
    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
});
                        if (ringResponse.ok) {
                            const ringData = await ringResponse.json();
                            if (ringData.success && ringData.rings) {
                                // Filter rings that contain the current user
                                const userRings = ringData.rings.filter(ring => {
                                    return ring.members && ring.members.some(member => 
                                        member.userId === data.profile.id || member.id === data.profile.id
                                    );
                                });
                                currentLookupData.rings = userRings;
                            }
                        }
                    } catch (ringError) {
                        console.warn('Failed to fetch ring data:', ringError);
                        currentLookupData.rings = [];
                    }
                    
                    renderProfile(currentLookupData);

                } catch (error) {
                    console.error('Lookup Error:', error);
                    setErrorState(error.message);
                }
            };

            searchInput.addEventListener('keydown', e => e.key === 'Enter' && handleSearch());
            searchBtn.addEventListener('click', () => handleSearch());

            // --- Event Delegation ---
            resultContainer.addEventListener('click', (e) => {
                if (e.target.matches('.friend-link, .friend-link *')) {
                    e.preventDefault();
                    const friendName = e.target.closest('.friend-link').dataset.username;
                    if (friendName) handleSearch(friendName);
                }
                
                // Handle "Show More Groups" button
                if (e.target.id === 'show-more-groups-btn') {
                    const groupsGrid = document.getElementById('groups-grid');
                    const showMoreBtn = e.target;
                    const allGroups = currentLookupData.profile.groups;
                    
                    if (showMoreBtn.textContent.includes('Show') && !showMoreBtn.textContent.includes('Less')) {
                        // Show all groups
                        groupsGrid.innerHTML = allGroups.map(g => `<div class="stat-card flex items-center gap-3"><div class="flex-shrink-0"><i class="fas fa-users text-blue-400 text-xl"></i></div><div class="flex-grow min-w-0"><p class="font-semibold text-sm truncate">${g.name}</p><p class="text-xs text-gray-400">${g.role || 'Member'}</p></div></div>`).join('');
                        showMoreBtn.textContent = 'Show Less';
                    } else {
                        // Show only first 6 groups
                        groupsGrid.innerHTML = allGroups.slice(0, 6).map(g => `<div class="stat-card flex items-center gap-3"><div class="flex-shrink-0"><i class="fas fa-users text-blue-400 text-xl"></i></div><div class="flex-grow min-w-0"><p class="font-semibold text-sm truncate">${g.name}</p><p class="text-xs text-gray-400">${g.role || 'Member'}</p></div></div>`).join('');
                        showMoreBtn.textContent = `Show ${allGroups.length - 6} More Groups`;
                    }
                }
                if (e.target.id === 'toggle-friends-btn') {
                    const grid = document.getElementById('friends-grid-container');
                    const pagination = document.getElementById('friends-pagination');
                    const isCollapsed = grid.classList.toggle('collapsed');
                    e.target.textContent = isCollapsed ? 'Show More' : 'Show Less';
                    pagination.classList.toggle('hidden', isCollapsed);
                    if (!isCollapsed) renderFriendsPage(1); else renderFriendsPreview();
                }
                if (e.target.id === 'prev-friend-page' && !e.target.disabled) renderFriendsPage(currentFriendsPage - 1);
                if (e.target.id === 'next-friend-page' && !e.target.disabled) renderFriendsPage(currentFriendsPage + 1);

                const actionsMenuBtn = e.target.closest('#actions-menu-btn');
                if (actionsMenuBtn) {
                    document.getElementById('actions-menu-dropdown').classList.toggle('hidden');
                } else if (!e.target.closest('#actions-menu-dropdown')) {
                    const dropdown = document.getElementById('actions-menu-dropdown');
                    if (dropdown) dropdown.classList.add('hidden');
                }

                if (e.target.closest('#action-mark-poi')) handleMarkPOI();
                if (e.target.closest('#action-unmark-poi')) handleUnmarkPOI();
                if (e.target.closest('#action-view-poi')) handleViewPOI();
                
                // Handle ring management actions
                if (e.target.closest('#action-add-to-ring')) handleAddToRing();
                if (e.target.closest('#action-remove-from-ring')) handleRemoveFromRing();
                if (e.target.closest('#action-create-ring')) handleCreateRing();
                
                // Handle ring details button
                if (e.target.closest('.ring-details-btn')) {
                    const ringId = e.target.closest('.ring-details-btn').dataset.ringId;
                    if (ringId) handleViewRingDetails(ringId);
                }
                
                // Handle ring member navigation
                if (e.target.closest('.ring-member-link')) {
                    e.preventDefault();
                    const username = e.target.closest('.ring-member-link').dataset.username;
                    if (username) handleSearch(username);
                }

                if (e.target.closest('#action-share-profile')) {
                    e.preventDefault();
                    const shareButton = e.target.closest('#action-share-profile');
                    const profileUrl = `${window.location.origin}${window.location.pathname}?lookup=${currentLookupData.profile.id}`;
                    navigator.clipboard.writeText(profileUrl).then(() => {
                        shareButton.innerHTML = `<i class="fas fa-check w-4 text-green-400"></i><span>Copied!</span>`;
                    }).catch(err => {
                        shareButton.innerHTML = `<i class="fas fa-times w-4 text-red-400"></i><span>Failed</span>`;
                    });
                    setTimeout(() => {
                        shareButton.innerHTML = `<i class="fas fa-share-alt w-4"></i><span>Share Profile</span>`;
                        document.getElementById('actions-menu-dropdown')?.classList.add('hidden');
                    }, 2000);
                }
            });

            // --- POI & Login Modal Logic ---
            poiCancelBtn.addEventListener('click', () => poiModal.classList.remove('flex'));
            poiSubmitBtn.addEventListener('click', handleSubmitPOI);
            poiDetailsCloseBtn.addEventListener('click', () => poiDetailsModal.classList.remove('flex'));
            sdisLoginCancelBtn.addEventListener('click', () => {
                sdisLoginModal.classList.remove('flex');
                afterLoginCallback = null;
            });
            sdisLoginSubmitBtn.addEventListener('click', handleLogin);
            sdisCodePhraseInput.addEventListener('keydown', e => e.key === 'Enter' && handleLogin());
            loginBtn.addEventListener('click', () => showLoginModal());
            logoutBtn.addEventListener('click', handleLogout);

            // Ring modal event listeners
            const ringSelectionModal = document.getElementById('ring-selection-modal');
            const ringSelectionCancelBtn = document.getElementById('ring-selection-cancel-btn');
            const ringSelectionSubmitBtn = document.getElementById('ring-selection-submit-btn');
            const createRingModal = document.getElementById('create-ring-modal');
            const createRingCancelBtn = document.getElementById('create-ring-cancel-btn');
            const createRingSubmitBtn = document.getElementById('create-ring-submit-btn');
            const ringNameInput = document.getElementById('ring-name');
            const ringDescriptionInput = document.getElementById('ring-description');
            const addCurrentUserCheckbox = document.getElementById('add-current-user');
            const ringNameError = document.getElementById('ring-name-error');
            const ringDescriptionError = document.getElementById('ring-description-error');
            const descriptionCharCount = document.getElementById('description-char-count');

            ringSelectionCancelBtn.addEventListener('click', () => ringSelectionModal.classList.remove('flex'));
            ringSelectionSubmitBtn.addEventListener('click', handleRingSelectionSubmit);
            createRingCancelBtn.addEventListener('click', () => createRingModal.classList.remove('flex'));
            createRingSubmitBtn.addEventListener('click', handleCreateRingSubmit);

            // Real-time validation listeners
            ringNameInput.addEventListener('input', () => {
                const nameValidation = validateRingName(ringNameInput.value);
                if (ringNameInput.value.trim()) {
                    if (!nameValidation.isValid) {
                        showFieldError(ringNameInput, ringNameError, nameValidation.error);
                    } else {
                        showFieldSuccess(ringNameInput, ringNameError);
                    }
                } else {
                    clearFieldValidation(ringNameInput, ringNameError);
                }
                validateRingForm();
            });

            ringDescriptionInput.addEventListener('input', () => {
                updateDescriptionCharCount();
                const descriptionValidation = validateRingDescription(ringDescriptionInput.value);
                if (ringDescriptionInput.value.trim()) {
                    if (!descriptionValidation.isValid) {
                        showFieldError(ringDescriptionInput, ringDescriptionError, descriptionValidation.error);
                    } else {
                        showFieldSuccess(ringDescriptionInput, ringDescriptionError);
                    }
                } else {
                    clearFieldValidation(ringDescriptionInput, ringDescriptionError);
                }
                validateRingForm();
            });

            // Validate on blur for better UX
            ringNameInput.addEventListener('blur', validateRingForm);
            ringDescriptionInput.addEventListener('blur', validateRingForm);

            // Ring details modal event listeners
            const ringDetailsModal = document.getElementById('ring-details-modal');
            const ringDetailsCloseBtn = document.getElementById('ring-details-close-btn');
            const memberSearchInput = document.getElementById('member-search');
            const refreshMembersBtn = document.getElementById('refresh-members-btn');
            const ringMembersPrevBtn = document.getElementById('ring-members-prev');
            const ringMembersNextBtn = document.getElementById('ring-members-next');

            ringDetailsCloseBtn.addEventListener('click', () => ringDetailsModal.classList.remove('flex'));
            memberSearchInput.addEventListener('input', handleMemberSearch);
            refreshMembersBtn.addEventListener('click', () => loadRingDetails(currentRingId, true));
            ringMembersPrevBtn.addEventListener('click', () => changeMembersPage(-1));
            ringMembersNextBtn.addEventListener('click', () => changeMembersPage(1));

            const setLoadingState = () => {
                resultContainer.innerHTML = `<div class="text-center p-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto"></div><p class="mt-4 text-gray-400">Fetching user data...</p></div>`;
            };
            const setErrorState = (message) => {
                document.body.classList.remove('poi-background');
                resultContainer.innerHTML = `<div class="text-center p-8 bg-[#1f222c] rounded-lg"><p class="font-bold text-red-400">Error</p><p class="text-sm mt-1 text-gray-300">${message}</p></div>`;
            };

            const formatDuration = (ms) => {
                if (!ms) return 'N/A';
                let seconds = Math.floor(ms / 1000); let minutes = Math.floor(seconds / 60); let hours = Math.floor(minutes / 60); let days = Math.floor(hours / 24);
                hours %= 24; minutes %= 60; seconds %= 60;
                if (days > 0) return `${days} day(s)`; if (hours > 0) return `${hours} hour(s)`; if (minutes > 0) return `${minutes} minute(s)`; return `${seconds} second(s)`;
            };

            const renderFriendCard = (friend, bannedFriends = []) => {
                const isBanned = bannedFriends.some(bf => bf.id === friend.id);
                // Fix: Use placeholder if avatarUrl is missing (avoids CORS issues)
                const avatarUrl = friend.avatarUrl || `https://placehold.co/150x150/1f222c/FFFFFF?text=${friend.name ? friend.name.charAt(0).toUpperCase() : '?'}`;
                return `<div class="relative">${isBanned ? `<div class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center" title="Banned Friend"><i class="fas fa-ban"></i></div>` : ''}<a href="#" class="friend-link stat-card text-center hover:bg-gray-700 transition-colors block" data-username="${friend.name}"><img src="${avatarUrl}" alt="${friend.name}'s avatar" class="w-16 h-16 rounded-full mx-auto border-2 ${isBanned ? 'border-red-500' : 'border-gray-600'}" onerror="this.src='https://placehold.co/150x150/1f222c/FFFFFF?text=?'"><p class="mt-2 text-sm font-semibold truncate">${friend.displayName}</p><p class="text-xs text-gray-400 truncate">@${friend.name}</p></a></div>`;
            };

            const renderFriendsPreview = () => {
                const grid = document.getElementById('friends-grid');
                if (!grid) return;
                grid.innerHTML = fullFriendsList.slice(0, 10).map(friend => renderFriendCard(friend, currentLookupData.bannedFriends || [])).join('');
            };

            const renderFriendsPage = (page) => {
                currentFriendsPage = page;
                const grid = document.getElementById('friends-grid');
                const pageInfo = document.getElementById('friend-page-info');
                const prevBtn = document.getElementById('prev-friend-page');
                const nextBtn = document.getElementById('next-friend-page');
                if (!grid || !pageInfo || !prevBtn || !nextBtn) return;

                const totalPages = Math.ceil(fullFriendsList.length / friendsPerPage);
                const start = (currentFriendsPage - 1) * friendsPerPage;
                const end = start + friendsPerPage;
                const paginatedFriends = fullFriendsList.slice(start, end);

                grid.innerHTML = paginatedFriends.map(friend => renderFriendCard(friend, currentLookupData.bannedFriends || [])).join('');
                pageInfo.textContent = `Page ${currentFriendsPage} of ${totalPages}`;
                prevBtn.disabled = currentFriendsPage === 1;
                nextBtn.disabled = currentFriendsPage === totalPages;
            };

            const renderProfile = (data) => {
                if (!data.profile || !data.profile.id) {
                    return setErrorState("User not found. Please check the username or ID and try again.");
                }

                const { profile, banHistory, bannedFriends, friends } = data;
                const hasBanHistory = banHistory && banHistory.length > 0;

                document.body.classList.toggle('poi-background', profile.isPOI);

                // Calculate risk assessment
                const safetyReport = calculateSafetyScore(profile, friends, data.rings || [], bannedFriends);

                const now = new Date().getTime();
                const activeBan = hasBanHistory ? banHistory.find(ban => ban.type === 'permban' || (ban.type === 'timeban' && (new Date(ban.Date).getTime() + ban.Duration) > now)) : null;

                // Enhanced date display with age
                let createdDate = 'Unknown';
                let accountAge = 'Unknown';
                
                if (profile.created) {
                    createdDate = new Date(profile.created).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
                    
                    // Use enhanced age from worker if available, otherwise calculate
                    if (profile.ageCategory) {
                        accountAge = profile.ageCategory;
                    } else {
                        const ageMs = Date.now() - new Date(profile.created).getTime();
                        const days = Math.floor(ageMs / (1000 * 60 * 60 * 24));
                        const years = Math.floor(days / 365);
                        const months = Math.floor((days % 365) / 30);
                        
                        if (years > 0) {
                            if (months > 0) {
                                accountAge = `${years}y ${months}m`;
                            } else {
                                accountAge = `${years}y`;
                            }
                        } else if (days > 30) {
                            accountAge = `${months}m`;
                        } else {
                            accountAge = `${days}d`;
                        }
                    }
                }

                let banInfoHtml = `<div class="p-4 rounded-lg bg-green-500/10 border border-green-500/30 flex items-center gap-3"><i class="fas fa-check-circle text-green-400 text-2xl"></i><div><h4 class="font-bold text-green-300">No Active Ban</h4><p class="text-sm text-gray-400">This user does not have an active ban.</p></div></div>`;
                if (activeBan) {
                    banInfoHtml = `<div class="p-4 rounded-lg bg-red-500/10 border border-red-500/30"><div class="flex items-center gap-3 mb-4"><i class="fas fa-times-circle text-red-400 text-2xl"></i><div><h4 class="font-bold text-red-300">User is Banned</h4><p class="text-sm text-gray-400">This user has an active ban.</p></div></div><div class="space-y-2 text-sm"><p><strong class="text-gray-300">Reason:</strong> ${activeBan.Reason || 'N/A'}</p><p><strong class="text-gray-300">Moderator:</strong> ${activeBan.Moderator || 'N/A'}</p><p><strong class="text-gray-300">Date:</strong> ${new Date(activeBan.Date).toLocaleString()}</p></div></div>`;
                }

                const banHistoryHtml = hasBanHistory ? `
                        <div class="overflow-x-auto"><table class="w-full text-sm ban-history-table rounded-lg overflow-hidden"><thead><tr><th>Reason</th><th>Moderator</th><th>Date</th><th>Type</th><th>Duration</th></tr></thead><tbody>
                            ${banHistory.map(ban => `<tr><td>${ban.Reason || 'N/A'}</td><td>${ban.Moderator || 'N/A'}</td><td>${new Date(ban.Date).toLocaleString()}</td><td>${ban.type === 'permban' ? 'Permanent' : 'Temporary'}</td><td>${ban.type === 'timeban' ? formatDuration(ban.Duration) : 'Permanent'}</td></tr>`).join('')}
                        </tbody></table></div>` : `<p class="text-sm text-gray-400">No ban history found for this user.</p>`;

                const friendsHtml = friends?.length > 0 ? `
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg">Friends (${friends.length})</h3><div id="friends-pagination" class="hidden items-center gap-2"><button id="prev-friend-page" class="custom-button !px-3 !py-1 text-xs">&lt;</button><span id="friend-page-info" class="text-sm text-gray-400"></span><button id="next-friend-page" class="custom-button !px-3 !py-1 text-xs">&gt;</button></div></div>
                        <div id="friends-grid-container" class="collapsed"><div id="friends-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div></div>
                        ${friends.length > 10 ? `<div class="text-center mt-4"><button id="toggle-friends-btn" class="text-blue-400 hover:underline">Show More</button></div>` : ''}`
                    : `<h3 class="font-bold text-lg mb-2">Friends</h3><p class="text-sm text-gray-400">${friends ? 'This user has no friends, or their friends list is private.' : 'Could not load friends list.'}</p>`;

                const actionsMenuHtml = `
                        <div class="relative">
                            <button id="actions-menu-btn" class="text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-gray-700"><i class="fas fa-ellipsis-v"></i></button>
                            <div id="actions-menu-dropdown" class="actions-menu hidden bg-[#1f222c] border border-gray-700 rounded-lg shadow-xl w-48 text-sm">
                                <a href="#" id="action-share-profile" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-700"><i class="fas fa-share-alt w-4"></i><span>Share Profile</span></a><hr class="border-gray-700 my-1">
                                <a href="#" id="action-add-to-ring" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-700 text-red-300"><i class="fas fa-link w-4"></i><span>Add to Ring</span></a>
                                <a href="#" id="action-remove-from-ring" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-700 text-red-400"><i class="fas fa-unlink w-4"></i><span>Remove from Ring</span></a>
                                <a href="#" id="action-create-ring" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-700 text-red-300"><i class="fas fa-plus-circle w-4"></i><span>Create New Ring</span></a><hr class="border-gray-700 my-1">
                                <a href="#" id="action-mark-poi" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-700"><i class="fas fa-exclamation-triangle w-4"></i><span>Mark as POI</span></a>
                                <a href="#" id="action-unmark-poi" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-700 text-red-400"><i class="fas fa-times w-4"></i><span>Unmark POI</span></a>
                                <a href="#" id="action-view-poi" class="flex items-center gap-3 px-4 py-2 hover:bg-gray-700"><i class="fas fa-info-circle w-4"></i><span>View POI Details</span></a>
                            </div>
                        </div>`;

                // Generate risk assessment HTML
                const riskAssessmentHtml = renderRiskAssessment(safetyReport);
                
                // Main profile content
                const profileContent = `
                    <div class="bg-[#15171c] p-6 sm:p-8 rounded-lg shadow-lg relative ${profile.isPOI ? 'poi-profile-container' : ''}">
                        <div class="absolute top-4 right-4">${actionsMenuHtml}</div>
                        ${profile.groupRole ? `<div class="absolute top-6 right-20 bg-[#0c0d0e] px-4 py-2 rounded-full text-sm font-bold border shadow-lg" style="color: ${profile.groupRoleColor || '#9ca3af'}; border-color: ${profile.groupRoleColor || '#374151'};"><i class="fas fa-shield-alt mr-2"></i><span>${profile.groupRole}</span></div>` : ''}
                        <div class="flex flex-col sm:flex-row items-center sm:items-start text-center sm:text-left">
                            <div class="relative">
                                <img src="${profile.avatarUrl}" alt="User Avatar" class="w-32 h-32 rounded-full border-4 border-gray-700">
                                ${data.rings && data.rings.length > 0 ? `<div class="absolute -top-2 -right-2 flex flex-wrap gap-1">${data.rings.slice(0, 3).map((ring, index) => `<div class="bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center border-2 border-gray-800 shadow-lg" title="Ring: ${ring.name}" style="z-index: ${10 - index}; margin-left: ${index * -8}px;"><i class="fas fa-link"></i></div>`).join('')}${data.rings.length > 3 ? `<div class="bg-red-600 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center border-2 border-gray-800 shadow-lg font-bold" title="${data.rings.length - 3} more rings" style="margin-left: -8px;">+${data.rings.length - 3}</div>` : ''}</div>` : ''}
                            </div>
                            <div class="sm:ml-6 mt-4 sm:mt-0"><h2 class="text-3xl font-bold">${profile.displayName}</h2><p class="text-gray-400">@${profile.name}</p><a href="https://www.roblox.com/users/${profile.id}/profile" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline text-sm mt-1 inline-block">View on Roblox <i class="fas fa-external-link-alt ml-1"></i></a></div>
                        </div>
                        ${profile.isPOI ? `<div class="poi-alert-card mt-6"><div class="flex items-start"><i class="fas fa-exclamation-triangle text-red-400 text-4xl mr-4 mt-1"></i><div><h3 class="text-2xl font-bold text-red-300">Person of Interest</h3><p class="text-sm text-gray-300 mt-1">This user has been flagged by SDIS. Exercise caution.</p><div class="mt-4 pt-4 border-t border-red-700/50 space-y-2 text-sm"><div><strong class="text-gray-400 font-semibold block">Marked By:</strong><span id="poi-card-marked-by" class="text-white">Loading...</span></div><div><strong class="text-gray-400 font-semibold block">Date Marked:</strong><span id="poi-card-date" class="text-white">Loading...</span></div><div><strong class="text-gray-400 font-semibold block">Reason:</strong><p id="poi-card-reason" class="text-white whitespace-pre-wrap bg-red-900/20 p-2 rounded mt-1">Loading...</p></div></div></div></div></div>` : ''}
                        <div class="mt-6 border-t border-gray-700 pt-6"><h3 class="font-bold text-lg mb-2">About</h3><p class="text-gray-300 whitespace-pre-wrap">${profile.description || 'No bio available.'}</p></div>
                        ${data.rings && data.rings.length > 0 ? `<div class="mt-6 border-t border-red-700/30 pt-6 bg-red-900/10 p-4 rounded-lg"><h3 class="font-bold text-lg mb-4 text-red-300"><i class="fas fa-link mr-2"></i>Exploiter Rings (${data.rings.length})</h3><div class="space-y-3">${data.rings.map(ring => `<div class="bg-red-900/20 border border-red-700/40 rounded-lg p-4"><div class="flex items-center justify-between mb-2"><h4 class="font-semibold text-red-200">${ring.name}</h4><span class="text-xs text-red-400 bg-red-800/30 px-2 py-1 rounded">${ring.members ? ring.members.length : 0} members</span></div>${ring.description ? `<p class="text-sm text-gray-300 mb-3">${ring.description}</p>` : ''}${ring.members && ring.members.length > 0 ? `<div class="mb-3"><p class="text-xs text-gray-400 mb-2">Other Members:</p><div class="flex flex-wrap gap-2">${ring.members.filter(m => m.userId !== profile.id).slice(0, 5).map(member => `<a href="#" class="ring-member-link text-red-300 hover:text-red-200 text-xs bg-red-800/30 px-2 py-1 rounded transition-colors" data-username="${member.username || member.name}" title="View ${member.username || member.name}'s profile">${member.username || member.name}</a>`).join('')}${ring.members.filter(m => m.userId !== profile.id).length > 5 ? `<span class="text-xs text-gray-400 bg-red-800/20 px-2 py-1 rounded">+${ring.members.filter(m => m.userId !== profile.id).length - 5} more</span>` : ''}</div></div>` : ''}<div class="flex items-center gap-4 text-xs text-gray-400"><span><i class="fas fa-user mr-1"></i>Created by: ${ring.createdBy || ring.addedBy || 'Unknown'}</span><span><i class="fas fa-calendar mr-1"></i>${ring.createdAt ? new Date(ring.createdAt).toLocaleDateString() : ring.addedAt ? new Date(ring.addedAt).toLocaleDateString() : 'Unknown date'}</span></div><div class="mt-3 pt-3 border-t border-red-700/30"><button class="ring-details-btn text-red-300 hover:text-red-200 text-sm font-medium transition-colors" data-ring-id="${ring.id}"><i class="fas fa-eye mr-1"></i>View Ring Details</button></div></div>`).join('')}</div></div>` : ''}
                        ${riskAssessmentHtml}
                        <div class="mt-6 border-t border-gray-700 pt-6"><h3 class="font-bold text-lg mb-2">Stats</h3><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div class="stat-card"><p class="text-sm text-gray-400">Join Date</p><p class="font-bold text-lg">${createdDate}</p></div><div class="stat-card"><p class="text-sm text-gray-400">User ID</p><p class="font-bold text-lg">${profile.id}</p></div><div class="stat-card"><p class="text-sm text-gray-400">Friends</p><p class="font-bold text-lg">${profile.friendCount ?? 'N/A'}</p></div></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4"><div class="stat-card"><p class="text-sm text-gray-400">Account Age</p><p class="font-bold text-lg">${accountAge}</p></div><div class="stat-card"><p class="text-sm text-gray-400">Badges</p><p class="font-bold text-lg">${profile.badgeCount ?? 0}</p></div><div class="stat-card"><p class="text-sm text-gray-400">Activity Level</p><p class="font-bold text-lg">${profile.activityLevel || 'Unknown'}</p></div></div></div>
                        ${profile.notableBadges && profile.notableBadges.length > 0 ? `<div class="mt-6 border-t border-gray-700 pt-6"><h3 class="font-bold text-lg mb-4">Notable Badges</h3><div class="flex flex-wrap gap-2">${profile.notableBadges.map(badge => `<span class="inline-block bg-yellow-600/20 text-yellow-300 px-3 py-1 rounded-full text-sm font-medium border border-yellow-600/30" title="${badge.description || ''}">${badge.name}</span>`).join('')}</div></div>` : ''}
                        ${profile.groups && profile.groups.length > 0 ? `<div class="mt-6 border-t border-gray-700 pt-6"><h3 class="font-bold text-lg mb-4">Groups (${profile.groups.length})</h3><div id="groups-container"><div id="groups-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-3">${profile.groups.slice(0, 6).map(g => `<div class="stat-card flex items-center gap-3"><div class="flex-shrink-0"><i class="fas fa-users text-blue-400 text-xl"></i></div><div class="flex-grow min-w-0"><p class="font-semibold text-sm truncate">${g.name}</p><p class="text-xs text-gray-400">${g.role || 'Member'}</p></div></div>`).join('')}</div>${profile.groups.length > 6 ? `<div class="text-center mt-4"><button id="show-more-groups-btn" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition-colors">Show ${profile.groups.length - 6} More Groups</button></div>` : ''}</div></div>` : ''}
                        <div class="mt-6 border-t border-gray-700 pt-6"><h3 class="font-bold text-lg mb-4">Account Status</h3><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div class="stat-card flex items-center gap-3"><i class="fas ${profile.isPremium === true ? 'fa-star text-yellow-400' : profile.isPremium === false ? 'fa-user text-gray-400' : 'fa-question-circle text-gray-400'} text-xl"></i><div><p class="text-xs text-gray-400">Subscription</p><p class="font-semibold text-sm">${profile.isPremium === true ? 'Premium' : profile.isPremium === false ? 'Standard' : 'Unknown'}</p></div></div><div class="stat-card flex items-center gap-3"><i class="fas ${profile.inventoryHidden === false ? 'fa-eye text-green-400' : profile.inventoryHidden === true ? 'fa-eye-slash text-red-400' : 'fa-question-circle text-gray-400'} text-xl"></i><div><p class="text-xs text-gray-400">Inventory</p><p class="font-semibold text-sm">${profile.inventoryHidden === false ? 'Visible' : profile.inventoryHidden === true ? 'Hidden' : 'Unknown'}</p></div></div><div class="stat-card flex items-center gap-3"><i class="fas ${profile.hasVerifiedBadge ? 'fa-check-circle text-green-400' : 'fa-user text-gray-400'} text-xl"></i><div><p class="text-xs text-gray-400">Verification</p><p class="font-semibold text-sm">${profile.hasVerifiedBadge ? 'Verified' : 'Not Verified'}</p></div></div></div>${(profile.followersCount !== undefined || profile.followingCount !== undefined || profile.placeCount !== undefined) ? `<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">${profile.followersCount !== undefined ? `<div class="stat-card flex items-center gap-3"><i class="fas fa-users text-blue-400 text-xl"></i><div><p class="text-xs text-gray-400">Followers</p><p class="font-semibold text-sm">${profile.followersCount.toLocaleString()}</p></div></div>` : ''}${profile.followingCount !== undefined ? `<div class="stat-card flex items-center gap-3"><i class="fas fa-user-plus text-green-400 text-xl"></i><div><p class="text-xs text-gray-400">Following</p><p class="font-semibold text-sm">${profile.followingCount.toLocaleString()}</p></div></div>` : ''}${profile.placeCount !== undefined ? `<div class="stat-card flex items-center gap-3"><i class="fas fa-gamepad text-purple-400 text-xl"></i><div><p class="text-xs text-gray-400">Places</p><p class="font-semibold text-sm">${profile.placeCount}</p></div></div>` : ''}</div>` : ''}</div>
                        <div class="mt-6 border-t border-gray-700 pt-6"><h3 class="font-bold text-lg mb-2">Current Ban Status</h3>${banInfoHtml}</div>
                        <div class="mt-6 border-t border-gray-700 pt-6"><h3 class="font-bold text-lg mb-2">Ban History</h3>${banHistoryHtml}</div>
                        ${bannedFriends?.length > 0 ? `<div class="mt-6 border-t border-red-900 bg-red-900/10 p-6"><h3 class="text-lg font-semibold text-red-400 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Banned Friends (${bannedFriends.length})</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${bannedFriends.map(f => `<div class="bg-red-900/30 border border-red-800 rounded-lg p-4 flex items-center gap-3"><img src="${f.avatarUrl}" class="w-10 h-10 rounded-full border-2 border-red-500 mr-3"><div class="text-sm"><a href="#" class="friend-link text-red-300 hover:text-white font-medium" data-username="${f.name}">${f.displayName} (@${f.name})</a><div class="text-xs text-red-400">Banned: ${f.banInfo?.Date ? new Date(f.banInfo.Date).toLocaleDateString() : 'N/A'}</div>${f.banInfo?.Reason ? `<div class="text-xs text-red-300 mt-1"><span class="font-semibold">Reason:</span> ${f.banInfo.Reason}</div>` : ''}</div></div>`).join('')}</div></div>` : ''}
                        <div class="mt-6 border-t border-gray-700 pt-6">${friendsHtml}</div>
                    </div>
                `;

                // Render in inline mode with risk assessment positioned correctly
                resultContainer.innerHTML = `
                    ${profileContent}
                `;

                if (profile.isPOI) fetchAndRenderPOIDetails(profile.id);
                if (friends?.length > 0) renderFriendsPreview();
                updateAuthUI();
                updateMetaTags(profile);
            };

            // ===== CLIENT-SIDE VALIDATION FUNCTIONS =====

            function validateRingName(name) {
                const trimmed = name.trim();
                
                if (!trimmed) {
                    return { isValid: false, error: 'Ring name is required' };
                }
                
                if (trimmed.length < RING_VALIDATION.NAME_MIN_LENGTH) {
                    return { isValid: false, error: `Ring name must be at least ${RING_VALIDATION.NAME_MIN_LENGTH} characters` };
                }
                
                if (trimmed.length > RING_VALIDATION.NAME_MAX_LENGTH) {
                    return { isValid: false, error: `Ring name must be no more than ${RING_VALIDATION.NAME_MAX_LENGTH} characters` };
                }
                
                if (!RING_VALIDATION.VALID_NAME_PATTERN.test(trimmed)) {
                    return { isValid: false, error: 'Ring name contains invalid characters. Only letters, numbers, spaces, hyphens, underscores, and periods are allowed' };
                }
                
                return { isValid: true };
            }

            function validateRingDescription(description) {
                const trimmed = description.trim();
                
                if (trimmed.length > RING_VALIDATION.DESCRIPTION_MAX_LENGTH) {
                    return { isValid: false, error: `Description must be no more than ${RING_VALIDATION.DESCRIPTION_MAX_LENGTH} characters` };
                }
                
                return { isValid: true };
            }

            function showFieldError(field, errorElement, message) {
                field.classList.add('form-field-error');
                field.classList.remove('form-field-success');
                errorElement.textContent = message;
                errorElement.classList.remove('hidden');
            }

            function showFieldSuccess(field, errorElement) {
                field.classList.add('form-field-success');
                field.classList.remove('form-field-error');
                errorElement.classList.add('hidden');
            }

            function clearFieldValidation(field, errorElement) {
                field.classList.remove('form-field-error', 'form-field-success');
                errorElement.classList.add('hidden');
            }

            function validateRingForm() {
                const name = ringNameInput.value;
                const description = ringDescriptionInput.value;
                let isValid = true;

                // Validate name
                const nameValidation = validateRingName(name);
                if (!nameValidation.isValid) {
                    showFieldError(ringNameInput, ringNameError, nameValidation.error);
                    isValid = false;
                } else {
                    showFieldSuccess(ringNameInput, ringNameError);
                }

                // Validate description
                const descriptionValidation = validateRingDescription(description);
                if (!descriptionValidation.isValid) {
                    showFieldError(ringDescriptionInput, ringDescriptionError, descriptionValidation.error);
                    isValid = false;
                } else {
                    showFieldSuccess(ringDescriptionInput, ringDescriptionError);
                }

                // Update submit button state
                createRingSubmitBtn.disabled = !isValid;
                createRingSubmitBtn.style.opacity = isValid ? '1' : '0.5';

                return isValid;
            }

            function updateDescriptionCharCount() {
                const count = ringDescriptionInput.value.length;
                const maxLength = RING_VALIDATION.DESCRIPTION_MAX_LENGTH;
                descriptionCharCount.textContent = count;
                
                const charCountElement = descriptionCharCount.parentElement;
                charCountElement.classList.remove('char-counter', 'warning', 'error');
                charCountElement.classList.add('char-counter');
                
                if (count > maxLength * 0.9) {
                    charCountElement.classList.add('warning');
                }
                if (count > maxLength) {
                    charCountElement.classList.add('error');
                }
            }

            <!-- --- Auth Functions --- -->
            function updateAuthUI() {
                const isAuth = !!currentUser;
                loginContainer.classList.toggle('hidden', isAuth);
                userStatusContainer.classList.toggle('hidden', !isAuth);

                const markPoi = document.getElementById('action-mark-poi');
                const unmarkPoi = document.getElementById('action-unmark-poi');
                const viewPoi = document.getElementById('action-view-poi');
                const addToRing = document.getElementById('action-add-to-ring');
                const removeFromRing = document.getElementById('action-remove-from-ring');
                const createRing = document.getElementById('action-create-ring');

                if (markPoi && unmarkPoi && viewPoi) {
                    const isPOI = currentLookupData?.profile?.isPOI;
                    markPoi.style.display = isAuth && !isPOI ? 'flex' : 'none';
                    unmarkPoi.style.display = isAuth && isPOI ? 'flex' : 'none';
                    viewPoi.style.display = isAuth && isPOI ? 'flex' : 'none';
                }

                if (addToRing && removeFromRing && createRing) {
                    const userInRings = currentLookupData?.rings?.length > 0;
                    addToRing.style.display = isAuth ? 'flex' : 'none';
                    removeFromRing.style.display = isAuth && userInRings ? 'flex' : 'none';
                    createRing.style.display = isAuth ? 'flex' : 'none';
                }

                if (isAuth) {
                    userStatusName.textContent = currentUser.displayName || currentUser.username;
                    userStatusAvatar.src = currentUser.avatarUrl || 'https://placehold.co/40x40/1f222c/FFFFFF?text=?';
                    userStatusRole.textContent = currentUser.sdisRole || 'SDIS Operative';
                    poiNameInput.value = currentUser.displayName || currentUser.username;
                }
            }

            function showLoginModal(callback) {
                afterLoginCallback = callback;
                sdisLoginModal.classList.add('flex');
                sdisCodePhraseInput.focus();
            }

            function checkAuth() {
                authToken = localStorage.getItem('sdis_token');
                const storedUser = localStorage.getItem('sdis_user');
                if (authToken && storedUser) {
                    currentUser = JSON.parse(storedUser);
                } else {
                    currentUser = null;
                    authToken = null;
                    localStorage.removeItem('sdis_token');
                    localStorage.removeItem('sdis_user');
                }
                updateAuthUI();
            }

            async function handleLogin() {
                const codePhrase = sdisCodePhraseInput.value.trim();
                if (!codePhrase) return;

                sdisLoginSubmitBtn.disabled = true;
                sdisLoginSubmitBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Authenticating...`;

                try {
                    const response = await fetch(`${AUTH_WORKER_URL}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ codePhrase })
                    });
                    const result = await response.json();
                    if (result.success && result.token && result.user) {
                        authToken = result.token;
                        currentUser = result.user;
                        localStorage.setItem('sdis_token', authToken);
                        localStorage.setItem('sdis_user', JSON.stringify(currentUser));

                        updateAuthUI();
                        sdisLoginModal.classList.remove('flex');
                        sdisCodePhraseInput.value = '';
                        showNotification('Login successful!', 'success');

                        if (typeof afterLoginCallback === 'function') {
                            afterLoginCallback();
                            afterLoginCallback = null;
                        }
                    } else {
                        throw new Error(result.error || 'Login failed');
                    }
                } catch (error) {
                    showNotification(`Error: ${error.message}`, 'error');
                } finally {
                    sdisLoginSubmitBtn.disabled = false;
                    sdisLoginSubmitBtn.textContent = 'Authenticate';
                }
            }

            function handleLogout() {
                authToken = null;
                currentUser = null;
                localStorage.removeItem('sdis_token');
                localStorage.removeItem('sdis_user');
                updateAuthUI();
                showNotification('You have been logged out.', 'info');
            }

            // --- POI Functions ---
            function handleMarkPOI() { if (!currentUser) return showLoginModal(handleMarkPOI); poiModal.classList.add('flex'); poiReasonInput.focus(); }
            function handleUnmarkPOI() { if (!currentUser) return showLoginModal(handleUnmarkPOI); unmarkPOI(); }
            function handleViewPOI() { if (!currentUser) return showLoginModal(handleViewPOI); fetchAndShowPOIDetails(currentLookupData.profile.id); }
            
            function handleViewRingDetails(ringId) {
                loadRingDetails(ringId);
            }
            
            function handleAddToRing() {
                if (!currentUser) return showLoginModal(handleAddToRing);
                showRingSelectionModal('add');
            }
            
            function handleRemoveFromRing() {
                if (!currentUser) return showLoginModal(handleRemoveFromRing);
                showRingSelectionModal('remove');
            }
            
            function handleCreateRing() {
                if (!currentUser) return showLoginModal(handleCreateRing);
                showCreateRingModal();
            }

            // Ring details functionality
            let currentRingId = null;
            let currentRingMembers = [];
            let filteredRingMembers = [];
            let currentMembersPage = 1;
            const membersPerPage = 10;

            async function loadRingDetails(ringId, forceRefresh = false) {
                currentRingId = ringId;
                const modal = document.getElementById('ring-details-modal');
                
                try {
                    // Show loading state
                    document.getElementById('ring-details-title').textContent = 'Loading Ring Details...';
                    modal.classList.add('flex');
                    
                    // Fetch detailed ring information
                    const response = await fetch(`${AUTH_WORKER_URL}/rings/${ringId}`, {
                        headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch ring details');
                    
                    const result = await response.json();
                    if (!result.success) throw new Error(result.error || 'Failed to load ring details');
                    
                    const ring = result.ring;
                    currentRingMembers = ring.members || [];
                    filteredRingMembers = [...currentRingMembers];
                    currentMembersPage = 1;
                    
                    // Populate ring information
                    document.getElementById('ring-details-title').textContent = 'Ring Details';
                    document.getElementById('ring-details-name').textContent = ring.name;
                    document.getElementById('ring-details-description').textContent = ring.description || 'No description provided';
                    document.getElementById('ring-details-member-count').textContent = `${ring.members?.length || 0} members`;
                    document.getElementById('ring-details-status').textContent = ring.isActive ? 'Active' : 'Inactive';
                    document.getElementById('ring-details-created-by').textContent = ring.createdBy || 'Unknown';
                    document.getElementById('ring-details-created-date').textContent = ring.createdAt ? new Date(ring.createdAt).toLocaleDateString() : 'Unknown';
                    document.getElementById('ring-details-updated-date').textContent = ring.updatedAt ? new Date(ring.updatedAt).toLocaleDateString() : 'Unknown';
                    document.getElementById('ring-details-id').textContent = ring.id;
                    
                    // Update statistics
                    const totalMembers = ring.members?.length || 0;
                    const activeMembers = ring.members?.filter(m => m.isActive !== false).length || 0;
                    const recentActivity = ring.recentActivityCount || 0;
                    
                    document.getElementById('ring-stats-total-members').textContent = totalMembers;
                    document.getElementById('ring-stats-active-members').textContent = activeMembers;
                    document.getElementById('ring-stats-recent-activity').textContent = recentActivity;
                    
                    // Update status styling
                    const statusEl = document.getElementById('ring-details-status');
                    statusEl.className = ring.isActive 
                        ? 'text-xs text-green-400 bg-green-800/30 px-2 py-1 rounded'
                        : 'text-xs text-red-400 bg-red-800/30 px-2 py-1 rounded';
                    
                    // Render members list
                    renderRingMembers();
                    
                } catch (error) {
                    console.error('Error loading ring details:', error);
                    showNotification(`Error loading ring details: ${error.message}`, 'error');
                    modal.classList.remove('flex');
                }
            }

            async function renderRingMembers() {
                const membersList = document.getElementById('ring-members-list');
                const membersInfo = document.getElementById('ring-members-info');
                const prevBtn = document.getElementById('ring-members-prev');
                const nextBtn = document.getElementById('ring-members-next');

                const totalMembers = filteredRingMembers.length;
                const totalPages = Math.ceil(totalMembers / membersPerPage);
                const startIndex = (currentMembersPage - 1) * membersPerPage;
                const endIndex = Math.min(startIndex + membersPerPage, totalMembers);
                const pageMembers = filteredRingMembers.slice(startIndex, endIndex);

                // Show loading state first
                membersList.innerHTML = pageMembers.map(() => `
                    <div class="bg-gray-700/40 border border-gray-600 rounded-lg p-4 animate-pulse">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-16 h-16 bg-gray-600 rounded-full mb-3"></div>
                            <div class="w-20 h-4 bg-gray-600 rounded mb-2"></div>
                            <div class="w-16 h-3 bg-gray-600 rounded mb-3"></div>
                            <div class="flex gap-2">
                                <div class="w-12 h-6 bg-gray-600 rounded"></div>
                                <div class="w-12 h-6 bg-gray-600 rounded"></div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Try to load Roblox avatars (will fallback if CORS fails)
                if (typeof loadRobloxAvatarsBatch === 'function') {
                    try {
                        await loadRobloxAvatarsBatch(pageMembers);
                    } catch (error) {
                        console.warn('Avatar loading failed, using fallbacks:', error);
                    }
                }

                // Render enhanced member cards
                membersList.innerHTML = pageMembers.map((member, index) => {
                    const username = member.username || member.name;
                    const displayName = member.displayName || username;
                    const avatarInitial = displayName.charAt(0).toUpperCase();

                    // Try to get cached avatar, fallback to member's existing avatarUrl or placeholder
                    let avatarUrl = member.avatarUrl || `https://placehold.co/80x80/1f222c/FFFFFF?text=${avatarInitial}`;
                    if (typeof avatarCache !== 'undefined' && avatarCache.has(member.userId)) {
                        avatarUrl = avatarCache.get(member.userId);
                    }

                    return `
                    <div class="bg-gray-700/40 border border-gray-600 rounded-lg p-4 hover:bg-gray-700/60 transition-all duration-200 hover:border-gray-500">
                        <div class="flex flex-col items-center text-center">
                            <div class="relative mb-3">
                                <img src="${avatarUrl}" 
                                     alt="${displayName}'s avatar" 
                                     class="w-16 h-16 rounded-full border-3 border-gray-500 hover:border-gray-400 transition-colors"
                                     onerror="this.src='https://placehold.co/80x80/1f222c/FFFFFF?text=${avatarInitial}'">
                                ${member.isActive === false ? '<div class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"><i class="fas fa-ban"></i></div>' : ''}
                            </div>
                            <div class="w-full">
                                <div class="font-medium text-white hover:text-red-300 transition-colors mb-1">
                                    ${displayName}
                                </div>
                                <div class="text-xs text-gray-400 mb-2">
                                    @${username}
                                </div>
                                <div class="text-xs text-gray-500 mb-3 leading-relaxed">
                                    <div>ID: ${member.userId}</div>
                                    <div>Added: ${member.addedAt ? new Date(member.addedAt).toLocaleDateString() : 'Unknown'}</div>
                                    ${member.addedBy ? `<div>By: ${member.addedBy}</div>` : ''}
                                </div>
                                <div class="flex items-center justify-center gap-2">
                                    <button class="member-view-btn text-blue-400 hover:text-blue-300 text-xs px-2 py-1 bg-blue-900/30 hover:bg-blue-900/50 rounded transition-colors" 
                                            data-username="${username}"
                                            title="View Profile">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                    ${authToken ? `<button class="member-remove-btn text-red-400 hover:text-red-300 text-xs px-2 py-1 bg-red-900/30 hover:bg-red-900/50 rounded transition-colors" 
                                                           data-user-id="${member.userId}"
                                                           data-username="${username}"
                                                           title="Remove from Ring">
                                        <i class="fas fa-times mr-1"></i>Remove
                                    </button>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                // Add event listeners to the new buttons - using direct function calls
                const viewButtons = membersList.querySelectorAll('.member-view-btn');
                const removeButtons = membersList.querySelectorAll('.member-remove-btn');

                viewButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const username = btn.dataset.username;
                        console.log('View button clicked for:', username);
                        handleSearch(username);
                    });
                });

                removeButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const userId = btn.dataset.userId;
                        const username = btn.dataset.username;
                        console.log('Remove button clicked for:', username, userId);
                        removeMemberFromRing(userId);
                    });
                });

                // Update pagination info
                membersInfo.textContent = totalMembers > 0 
                    ? `Showing ${startIndex + 1}-${endIndex} of ${totalMembers} members`
                    : 'No members found';

                // Update pagination buttons
                prevBtn.disabled = currentMembersPage <= 1;
                nextBtn.disabled = currentMembersPage >= totalPages;
            }

            function handleMemberSearch() {
                const searchTerm = document.getElementById('member-search').value.toLowerCase().trim();
                
                if (!searchTerm) {
                    filteredRingMembers = [...currentRingMembers];
                } else {
                    filteredRingMembers = currentRingMembers.filter(member => {
                        const username = (member.username || member.name || '').toLowerCase();
                        const displayName = (member.displayName || '').toLowerCase();
                        const userId = (member.userId || '').toString();
                        
                        return username.includes(searchTerm) || 
                               displayName.includes(searchTerm) || 
                               userId.includes(searchTerm);
                    });
                }
                
                currentMembersPage = 1;
                renderRingMembers();
            }

            function changeMembersPage(direction) {
                const totalPages = Math.ceil(filteredRingMembers.length / membersPerPage);
                const newPage = currentMembersPage + direction;
                
                if (newPage >= 1 && newPage <= totalPages) {
                    currentMembersPage = newPage;
                    renderRingMembers();
                }
            }

            async function removeMemberFromRing(userId) {
                if (!authToken) {
                    showNotification('Authentication required', 'error');
                    return;
                }
                
                if (!confirm('Are you sure you want to remove this member from the ring?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`${AUTH_WORKER_URL}/rings/${currentRingId}/members`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            userIds: [userId]
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Member removed from ring', 'success');
                        // Refresh the ring details
                        loadRingDetails(currentRingId, true);
                        // Also refresh the main profile if it's the same user
                        if (currentLookupData?.profile?.id == userId) {
                            handleSearch(currentLookupData.profile.id.toString());
                        }
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showNotification(`Error removing member: ${error.message}`, 'error');
                }
            }

            let currentRingAction = null;
            let availableRings = [];

            async function showRingSelectionModal(action) {
                currentRingAction = action;
                const modal = document.getElementById('ring-selection-modal');
                const title = document.getElementById('ring-selection-title');
                const list = document.getElementById('ring-selection-list');
                
                title.textContent = action === 'add' ? 'Add to Ring' : 'Remove from Ring';
                
                // Fetch available rings
                try {
                    const response = await fetch(`${AUTH_WORKER_URL}/rings`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        availableRings = result.rings || [];
                        
                        if (action === 'remove') {
                            // Filter to only rings the user is in
                            availableRings = availableRings.filter(ring => 
                                currentLookupData.rings?.some(userRing => userRing.id === ring.id)
                            );
                        }
                        
                        if (availableRings.length === 0) {
                            list.innerHTML = `<p class="text-gray-400 text-sm">${action === 'add' ? 'No rings available. Create a new ring first.' : 'User is not in any rings.'}</p>`;
                        } else {
                            list.innerHTML = availableRings.map(ring => `
                                <label class="flex items-center gap-3 p-3 bg-gray-700/30 rounded cursor-pointer hover:bg-gray-700/50">
                                    <input type="radio" name="selected-ring" value="${ring.id}" class="text-red-500">
                                    <div class="flex-grow">
                                        <p class="font-medium text-white">${ring.name}</p>
                                        <p class="text-xs text-gray-400">${ring.members ? ring.members.length : 0} members</p>
                                    </div>
                                </label>
                            `).join('');
                        }
                    } else {
                        list.innerHTML = '<p class="text-red-400 text-sm">Failed to load rings.</p>';
                    }
                } catch (error) {
                    list.innerHTML = '<p class="text-red-400 text-sm">Error loading rings.</p>';
                }
                
                modal.classList.add('flex');
            }

            function showCreateRingModal() {
                const modal = document.getElementById('create-ring-modal');
                
                // Reset form values
                document.getElementById('ring-name').value = '';
                document.getElementById('ring-description').value = '';
                document.getElementById('add-current-user').checked = true;
                
                // Reset validation state
                clearFieldValidation(ringNameInput, ringNameError);
                clearFieldValidation(ringDescriptionInput, ringDescriptionError);
                
                // Reset character count
                updateDescriptionCharCount();
                
                // Disable submit button initially
                createRingSubmitBtn.disabled = true;
                createRingSubmitBtn.style.opacity = '0.5';
                
                modal.classList.add('flex');
                ringNameInput.focus();
            }

            async function handleRingSelectionSubmit() {
                const selectedRing = document.querySelector('input[name="selected-ring"]:checked');
                if (!selectedRing) {
                    showNotification('Please select a ring', 'error');
                    return;
                }
                
                const ringId = selectedRing.value;
                const userData = currentLookupData.profile;
                
                try {
                    const endpoint = currentRingAction === 'add' 
                        ? `${AUTH_WORKER_URL}/rings/${ringId}/members`
                        : `${AUTH_WORKER_URL}/rings/${ringId}/members`;
                    
                    const method = currentRingAction === 'add' ? 'POST' : 'DELETE';
                    
                    const response = await fetch(endpoint, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            members: [{
                                userId: userData.id,
                                username: userData.name,
                                avatarUrl: userData.avatarUrl,
                                displayName: userData.displayName || userData.name
                            }]
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showNotification(`User ${currentRingAction === 'add' ? 'added to' : 'removed from'} ring`, 'success');
                        document.getElementById('ring-selection-modal').classList.remove('flex');
                        // Refresh the profile to show updated ring membership
                        handleSearch(userData.id.toString());
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showNotification(`Error: ${error.message}`, 'error');
                }
            }

            async function handleCreateRingSubmit() {
                const name = document.getElementById('ring-name').value.trim();
                const description = document.getElementById('ring-description').value.trim();
                const addCurrentUser = document.getElementById('add-current-user').checked;
                
                // Perform comprehensive client-side validation
                if (!validateRingForm()) {
                    showNotification('Please fix the validation errors before submitting', 'error');
                    return;
                }

                // Disable submit button during request
                createRingSubmitBtn.disabled = true;
                createRingSubmitBtn.textContent = 'Creating...';
                createRingSubmitBtn.style.opacity = '0.7';
                
                try {
                    const userData = currentLookupData.profile;
                    const response = await fetch(`${AUTH_WORKER_URL}/rings`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            name: name,
                            description: description,
                            initialMembers: addCurrentUser ? [{
                                userId: userData.id,
                                username: userData.name,
                                avatarUrl: userData.avatarUrl
                            }] : []
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Ring created successfully', 'success');
                        document.getElementById('create-ring-modal').classList.remove('flex');
                        // Refresh the profile to show updated ring membership
                        handleSearch(userData.id.toString());
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showNotification(`Error: ${error.message}`, 'error');
                } finally {
                    // Re-enable submit button
                    createRingSubmitBtn.disabled = false;
                    createRingSubmitBtn.textContent = 'Create Ring';
                    createRingSubmitBtn.style.opacity = '1';
                }
            }

            async function handleSubmitPOI() {
                const reason = poiReasonInput.value.trim();
                if (!reason) return showNotification('Reason is required.', 'error');

                const markerName = currentUser?.displayName || 'Unknown Operative';

                await submitPOI(currentLookupData.profile, markerName, reason);
                poiModal.classList.remove('flex');
                poiReasonInput.value = '';
            }

            async function submitPOI(userData, markerName, reason) {
                if (!userData || !markerName || !reason) {
                    console.error("submitPOI validation failed:", { userData, markerName, reason });
                    showNotification('Error: Missing data for POI submission.', 'error');
                    return;
                }
                try {
                    const response = await fetch(`${DATA_WORKER_URL}/poi`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({
                            userId: userData.id,
                            username: userData.name,
                            displayName: userData.displayName,
                            markedBy: markerName,
                            reason: reason,
                            timestamp: new Date().toISOString(),
                            avatarUrl: userData.avatarUrl
                        })
                    });
                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);
                    showNotification(`${userData.displayName} marked as POI`, 'success');
                    handleSearch(userData.id.toString());
                } catch (error) {
                    showNotification(`Error: ${error.message}`, 'error');
                }
            }

            async function unmarkPOI() {
                const userData = currentLookupData.profile;
                try {
                    const response = await fetch(`${DATA_WORKER_URL}/poi/${userData.id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const result = await response.json();
                    if (!result.success) throw new Error(result.error);
                    showNotification(`${userData.displayName} unmarked as POI`, 'success');
                    handleSearch(userData.id.toString());
                } catch (error) {
                    showNotification(`Error: ${error.message}`, 'error');
                }
            }

            async function fetchAndShowPOIDetails(userId) {
                try {
                    const response = await fetch(`${DATA_WORKER_URL}/poi/${userId}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const result = await response.json();
                    if (result.success && result.data) {
                        const data = result.data;
                        poiDetailsMarkedBy.textContent = data.markedBy || 'N/A';
                        poiDetailsReason.textContent = data.reason || 'No reason provided.';
                        poiDetailsDate.textContent = data.timestamp ? new Date(data.timestamp).toLocaleString() : 'N/A';
                        poiDetailsModal.classList.add('flex');
                    } else {
                        throw new Error(result.error || 'POI details not found');
                    }
                } catch (error) {
                    showNotification(`Error: ${error.message}`, 'error');
                }
            }

            async function fetchAndRenderPOIDetails(userId) {
                const markedByEl = document.getElementById('poi-card-marked-by');
                const reasonEl = document.getElementById('poi-card-reason');
                const dateEl = document.getElementById('poi-card-date');
                if (!markedByEl || !reasonEl || !dateEl) return;

                try {
                    const response = await fetch(`${DATA_WORKER_URL}/poi/${userId}`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                    const result = await response.json();
                    if (result.success && result.data) {
                        markedByEl.textContent = result.data.markedBy || 'N/A';
                        reasonEl.textContent = result.data.reason || 'No reason provided.';
                        dateEl.textContent = result.data.timestamp ? new Date(result.data.timestamp).toLocaleString() : 'N/A';
                    } else { throw new Error(result.error || 'POI details not found'); }
                } catch (error) {
                    console.error('Error fetching POI details for card:', error);
                    reasonEl.textContent = `Could not load POI details: ${error.message}`;
                }
            }


            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                const colors = { success: 'bg-green-600', warning: 'bg-yellow-600', error: 'bg-red-600', info: 'bg-blue-600' };
                notification.className = `fixed top-5 right-5 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm ${colors[type]} transition-transform duration-300 translate-x-full`;
                notification.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'} mr-2"></i>${message}`;
                document.body.appendChild(notification);
                setTimeout(() => notification.style.transform = 'translateX(0)', 100);
                setTimeout(() => {
                    notification.style.transform = 'translateX(calc(100% + 1.25rem))';
                    notification.addEventListener('transitionend', () => notification.remove());
                }, 3000);
            }

            function updateMetaTags(userData) {
                const title = `${userData.displayName}'s Profile | Saikou`;
                const description = `View ${userData.displayName}'s Roblox profile and moderation status on Saikou.`;
                const imageUrl = userData.avatarUrl || 'https://saikou.dev/assets/images/og-image.png';
                const currentUrl = `${window.location.origin}${window.location.pathname}?lookup=${userData.id}`;
                document.title = title;
                document.querySelector('meta[property="og:title"]').setAttribute('content', title);
                document.querySelector('meta[property="og:description"]').setAttribute('content', description);
                document.querySelector('meta[property="og:url"]').setAttribute('content', currentUrl);
                document.querySelector('meta[property="og:image"]').setAttribute('content', imageUrl);
                document.querySelector('meta[property="twitter:title"]').setAttribute('content', title);
                document.querySelector('meta[property="twitter:description"]').setAttribute('content', description);
                document.querySelector('meta[property="twitter:url"]').setAttribute('content', currentUrl);
                document.querySelector('meta[property="twitter:image"]').setAttribute('content', imageUrl);
            }

            // Initial Load
            const urlParams = new URLSearchParams(window.location.search);
            const lookupParam = urlParams.get('lookup');
            if (lookupParam) {
                handleSearch(lookupParam);
            }
            checkAuth();

            // Make toggleRiskAssessment globally available
            window.toggleRiskAssessment = toggleRiskAssessment;
        });
    
            // ===== ROBLOX AVATAR CACHING SYSTEM (CORS-SAFE) =====

            // Avatar cache with localStorage backup
            let avatarCache = new Map();
            const CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 hours
            const CACHE_KEY_PREFIX = 'roblox_avatar_';

            // Load cached avatars from localStorage on startup
            function loadAvatarCacheFromStorage() {
                try {
                    const keys = Object.keys(localStorage).filter(key => key.startsWith(CACHE_KEY_PREFIX));
                    keys.forEach(key => {
                        const cached = JSON.parse(localStorage.getItem(key));
                        if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                            const userId = key.replace(CACHE_KEY_PREFIX, '');
                            avatarCache.set(userId, cached.url);
                        } else {
                            localStorage.removeItem(key); // Clean expired cache
                        }
                    });
                    console.log(`Loaded ${avatarCache.size} cached avatars from storage`);
                } catch (error) {
                    console.warn('Failed to load avatar cache:', error);
                }
            }

            // Save avatar to cache and localStorage
            function cacheAvatar(userId, avatarUrl) {
                avatarCache.set(userId, avatarUrl);
                try {
                    localStorage.setItem(CACHE_KEY_PREFIX + userId, JSON.stringify({
                        url: avatarUrl,
                        timestamp: Date.now()
                    }));
                } catch (error) {
                    console.warn('Failed to save avatar to localStorage:', error);
                }
            }

            // CORS-safe Roblox avatar fetching using proxy
            async function getRobloxAvatarSafe(userId, username) {
                // Check cache first
                if (avatarCache.has(userId)) {
                    return avatarCache.get(userId);
                }

                try {
                    // Use allorigins.win as CORS proxy
                    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userId}&size=150x150&format=Png&isCircular=false`)}`;

                    const response = await fetch(proxyUrl);

                    if (!response.ok) {
                        throw new Error('Proxy request failed');
                    }

                    const data = await response.json();
                    const robloxData = JSON.parse(data.contents);

                    if (robloxData.data && robloxData.data.length > 0 && robloxData.data[0].imageUrl) {
                        const avatarUrl = robloxData.data[0].imageUrl;
                        cacheAvatar(userId, avatarUrl);
                        console.log(`Successfully loaded avatar for ${username}: ${avatarUrl}`);
                        return avatarUrl;
                    }

                } catch (error) {
                    console.warn(`Failed to fetch Roblox avatar for ${username} (${userId}):`, error);
                }

                // Fallback to placeholder
                const fallbackUrl = `https://placehold.co/150x150/1f222c/FFFFFF?text=${(username || '?').charAt(0).toUpperCase()}`;
                cacheAvatar(userId, fallbackUrl);
                console.log(`Using fallback avatar for ${username}`);
                return fallbackUrl;
            }

            // Batch load avatars with better error handling
            async function loadRobloxAvatarsBatch(members) {
                const uncachedMembers = members.filter(member => !avatarCache.has(member.userId));

                if (uncachedMembers.length === 0) {
                    console.log('All avatars already cached');
                    return;
                }

                console.log(`Loading ${uncachedMembers.length} uncached avatars...`);

                // Process one at a time to avoid overwhelming the proxy service
                for (const member of uncachedMembers) {
                    try {
                        await getRobloxAvatarSafe(member.userId, member.username || member.name);
                        // Small delay between requests
                        await new Promise(resolve => setTimeout(resolve, 300));
                    } catch (error) {
                        console.warn(`Failed to load avatar for ${member.username}:`, error);
                        // Cache a fallback
                        const fallbackUrl = `https://placehold.co/150x150/1f222c/FFFFFF?text=${(member.username || member.name || '?').charAt(0).toUpperCase()}`;
                        cacheAvatar(member.userId, fallbackUrl);
                    }
                }

                console.log(`Avatar loading complete. Cache now has ${avatarCache.size} entries.`);
            }

            // Initialize avatar cache on page load
            loadAvatarCacheFromStorage();

            // Make functions available globally for debugging
            window.avatarCache = avatarCache;
            window.getRobloxAvatarSafe = getRobloxAvatarSafe;
            window.loadRobloxAvatarsBatch = loadRobloxAvatarsBatch;

</script>
</body>

</html>