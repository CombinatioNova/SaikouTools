<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0 viewport-fit=cover" />
		<title>Saikou | Friend Connection Graph</title>
		<meta name="description" content="Visualize the network of friends between Roblox users for moderation and investigation." />
		<link rel="icon" type="image/png" href="https://saikou.dev/assets/images/favicon.png" onerror="this.onerror=null;this.href='https://placehold.co/32x32/121315/FFFFFF?text=S'" />

		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>

		<!-- D3.js for Graph Visualization -->
		<script src="https://d3js.org/d3.v7.min.js"></script>

		<!-- Fonts & Icons -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" xintegrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

		<style>
			body {
				font-family: 'Montserrat', sans-serif;
				background-color: #121315;
				color: white;
                overflow-y: auto;
			}
			input {
				background-color: #1f222c;
				border: 1px solid #353a4a;
				color: white;
				border-radius: 0.5rem;
				padding: 0.75rem;
                transition: border-color 0.3s ease;
			}
            input:focus {
                outline: none;
                border-color: #7f89ff;
            }
			.custom-button {
				font-weight: bold;
				border-radius: 0.5rem;
				color: #121315;
				background-color: #ffffff;
                padding: 0.75rem 1.5rem;
				opacity: 1;
				transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.3s ease;
                cursor: pointer;
			}
			.custom-button:hover:not(:disabled) {
				opacity: 0.8;
			}
            .custom-button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .graph-container {
                width: 100%;
                height: calc(100vh - 220px);
                position: relative;
                background-color: #15171c;
                border-radius: 0.5rem;
                overflow: hidden;
                margin: 1rem 0;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
            #graph-svg {
                width: 100%;
                height: 100%;
            }
            .node, .link {
                transition: opacity 0.3s ease, stroke-opacity 0.3s ease, display 0.3s;
            }
            .node-background {
                stroke-width: 3px;
                transition: all 0.3s ease;
                pointer-events: none;
                z-index: 1;
                fill: none; /* Makes it a ring */
            }
            .node image {
                pointer-events: none;
                z-index: 2;
            }
            .search-highlight {
                fill: transparent;
                transition: fill 0.3s ease, opacity 0.3s ease;
                pointer-events: none;
                z-index: 0;
                opacity: 0;
            }
            .node.searched .search-highlight {
                fill: #3b82f6;
                opacity: 0.4;
            }
            .node:not(.searched) .search-highlight {
                fill: #000000;
                opacity: 0.3;
            }
            .node.hovered .search-highlight,
            .node.seed-user .search-highlight {
                opacity: 0.1 !important; /* Very subtle highlight for hovered/seed nodes */
            }
            .node-background {
                transition: stroke 0.3s ease, stroke-width 0.3s ease;
            }
            .node.seed-user .node-background {
                stroke: #f59e0b !important;
                stroke-width: 3px !important;
                fill: #f59e0b !important;
                fill-opacity: 0.2 !important;
                z-index: 1;
            }
            
            /* Ensure seed user styles persist on hover */
            .node.seed-user:hover .node-background,
            .node.seed-user.hovered .node-background {
                stroke: #f59e0b !important;
                stroke-width: 3px !important;
                fill: #f59e0b !important;
                fill-opacity: 0.3 !important;
            }
            
            /* Remove any hover effects that might override the seed user style */
            .node.seed-user:hover circle:first-child,
            .node.seed-user.hovered circle:first-child {
                fill: transparent !important;
                stroke: none !important;
            }
            
            .node.searched .node-background {
                filter: drop-shadow(0 0 6px rgba(59, 130, 246, 0.8));
                transform: scale(1.05);
                transition: all 0.2s ease;
            }
            .node.banned .node-background {
                stroke: #f87171; /* Lighter red for border */
            }
            .link {
                stroke: #4b5563; /* Gray-600 */
                stroke-opacity: 0.6;
            }
            .link.former-link {
                stroke: #f87171; /* Red-400 */
                stroke-dasharray: 4;
                stroke-opacity: 0; /* Hidden by default */
                transition: stroke-opacity 0.3s;
            }
            #graph-svg.show-former-links .link.former-link {
                 stroke-opacity: 0.5; /* Visible when toggled */
            }
            #graph-svg .node:not(.searched) {
                opacity: 0.5; /* Increased darkening */
                transition: opacity 0.3s ease;
            }
            #graph-svg .node.searched {
                opacity: 1;
                filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.9)); /* Added glow effect */
            }
            .tooltip {
                position: absolute;
                background-color: rgba(12, 13, 14, 0.95);
                border: 1px solid #4b5563;
                border-radius: 0.5rem;
                padding: 0.5rem 0.75rem;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.1s;
                z-index: 10;
                transform: translate(15px, -50%);
                white-space: nowrap;
                max-width: none;
            }
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 50;
                transition: opacity 0.3s ease;
            }
            .modal-content {
                background-color: #1f222c;
                padding: 1.5rem;
                border-radius: 0.5rem;
                width: 90%;
                max-width: 350px;
                border: 1px solid #353a4a;
            }
            .progress-bar-container {
                width: 100%;
                background-color: #374151;
                border-radius: 9999px;
                height: 0.75rem;
            }
            .progress-bar {
                background-color: #4ade80;
                height: 0.75rem;
                border-radius: 9999px;
                transition: width 0.5s ease-out;
            }
            /* Graph Controls Container */
            .graph-controls {
                position: absolute;
                top: 1rem;
                right: 1rem;
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                z-index: 10;
                pointer-events: none;
            }
            
            .graph-controls > * {
                pointer-events: auto;
            }
            
            .graph-legend {
                background-color: rgba(12, 13, 14, 0.95);
                padding: 0.75rem;
                border-radius: 0.5rem;
                border: 1px solid #353a4a;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
                display: none; /* Hidden by default */
                width: 180px;
                backdrop-filter: blur(4px);
                margin-left: auto; /* Push to the right within the flex container */
            }
            
            .legend-title {
                font-size: 0.75rem;
                font-weight: 600;
                color: #9ca3af;
                margin-bottom: 0.5rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            
            .legend-item {
                display: flex;
                align-items: center;
                margin-bottom: 0.25rem;
            }
            
            .legend-color {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-right: 0.5rem;
                flex-shrink: 0;
            }
            
            .search-container {
                background-color: rgba(12, 13, 14, 0.95);
                padding: 0.75rem;
                border-radius: 0.5rem;
                border: 1px solid #353a4a;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
                width: 250px;
                display: none; /* Hidden by default */
            }
            .search-container input {
                width: 100%;
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
                background-color: #1f222c;
                border: 1px solid #353a4a;
                color: white;
                border-radius: 0.25rem;
            }
            .search-container label {
                display: block;
                font-size: 0.75rem;
                color: #9ca3af;
                margin-bottom: 0.25rem;
            }
            /* FAB Styling */
            #fab-container.open #fab-actions {
                transform: scale(1) translateY(0);
                opacity: 1;
                pointer-events: auto;
            }
            #fab-container.open #fab-main-btn {
                transform: rotate(45deg);
                background-color: #d1d5db; /* Lighter gray when open */
            }

            /* Toggle Switch Styles */
            .toggle-label {
                position: relative;
                display: flex;
                align-items: center;
                justify-content: space-between;
                cursor: pointer;
                font-size: 0.875rem;
                color: #d1d5db;
                padding: 0.25rem 0;
            }

            .toggle-label input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .toggle-switch {
                position: relative;
                display: inline-block;
                width: 40px;
                height: 22px;
                background-color: #4b5563;
                border-radius: 9999px;
                transition: background-color 0.2s;
            }

            .toggle-switch::after {
                content: '';
                position: absolute;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                background-color: white;
                top: 3px;
                left: 3px;
                transition: transform 0.2s;
            }

            .toggle-label input:checked + .toggle-switch {
                background-color: #3b82f6;
            }

            .toggle-label input:checked + .toggle-switch::after {
                transform: translateX(18px);
            }
		</style>
	</head>
	<body class="bg-[#121315]">
		<!-- Header -->
		<header class="container mx-auto px-4 md:px-0">
			<nav class="max-w-7xl mx-auto my-4 p-4 bg-[#0c0d0e] rounded-lg flex items-center justify-between">
				<a class="flex items-center" href="/index.html">
					<span class="text-white font-bold text-xl">[SDIS] Department of Institutional Security</span>
				</a>
			</nav>
		</header>

		<!-- Main Content -->
		<main class="container mx-auto px-4">
            <div class="max-w-7xl mx-auto">
                <div class="text-center">
                    <h1 class="text-4xl md:text-5xl font-bold">Personal Network Visualizer</h1>
                    <p class="mt-4 text-lg text-gray-300">Visualize the friend network between multiple Roblox users.</p>
                </div>

                <div class="mt-8 bg-[#1f222c] p-4 rounded-lg shadow-lg">
                    <div class="flex flex-col sm:flex-row gap-4 items-end">
                        <div class="flex-grow">
                            <label for="user-input" class="block text-sm font-medium text-gray-400 mb-1">Add Users by Username or ID</label>
                            <div class="flex gap-2">
                                <input type="text" id="user-input" class="w-full" placeholder="Enter username or ID...">
                                <button id="add-user-btn" class="custom-button">Add</button>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                             <button id="generate-graph-btn" class="custom-button bg-green-500 hover:bg-green-600 w-full sm:w-auto">Generate Graph</button>
                        </div>
                    </div>
                     <div id="seed-users-container" class="mt-3 flex flex-wrap gap-2"></div>
                </div>

                <!-- Graph Display -->
                <div id="graph-container" class="graph-container mt-4">
                    <div id="graph-tooltip" class="tooltip"></div>
                    <svg id="graph-svg"></svg>
                    
                    <!-- Controls that stay on graph -->
                    <div class="graph-controls">
                        <div class="search-container">
                            <label for="node-search" class="block text-xs font-medium text-gray-400 mb-1">Search Nodes</label>
                            <input type="text" id="node-search" class="w-full px-2 py-1 text-sm bg-[#1a1c23] border border-[#2d3748] rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent" placeholder="Search by username, ID, or display name...">
                        </div>
                        <div id="graph-legend" class="graph-legend">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <div id="graph-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500">
                        <p></p>
                    </div>
                </div>
            </div>
		</main>

        <!-- Modals -->
        <div id="profile-modal" class="modal-overlay hidden">
            <div id="modal-content" class="modal-content"></div>
        </div>
        <div id="loading-modal" class="modal-overlay hidden opacity-0">
             <div class="modal-content text-center">
                <h3 class="text-lg font-bold">Building Graph</h3>
                <div class="progress-bar-container mt-4">
                    <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-sm text-gray-400 mt-2">Initializing...</p>
             </div>
        </div>

        <!-- Floating Action Button -->
        <div id="fab-container" class="fixed bottom-6 right-6 z-30 flex flex-col items-center gap-3">
            <div id="fab-actions" class="flex flex-col items-center gap-3 transition-all duration-300 ease-in-out transform scale-90 opacity-0 -translate-y-4 pointer-events-none">
                <!-- MODIFIED: Filter Legend moved here -->
                <div id="filter-legend" class="bg-[#1f222c] p-3 rounded-lg shadow-lg w-44">
                    <div class="legend-title mb-2">Filter by Type</div>
                    <label class="toggle-label">
                        <span>Staff</span>
                        <input type="checkbox" class="filter-checkbox" data-filter="staff" checked>
                        <span class="toggle-switch"></span>
                    </label>
                     <label class="toggle-label">
                        <span>Banned/Terminated</span>
                        <input type="checkbox" class="filter-checkbox" data-filter="banned" checked>
                        <span class="toggle-switch"></span>
                    </label>
                    <label class="toggle-label">
                        <span>New Account (&lt;90d)</span>
                        <input type="checkbox" class="filter-checkbox" data-filter="new" checked>
                        <span class="toggle-switch"></span>
                    </label>
                    <label class="toggle-label">
                        <span>Normal User</span>
                        <input type="checkbox" class="filter-checkbox" data-filter="normal" checked>
                        <span class="toggle-switch"></span>
                    </label>
                </div>

                <div class="flex items-center justify-between gap-2 bg-[#1f222c] p-2 rounded-lg shadow-lg w-44">
                    <span class="text-xs font-semibold text-gray-300">Show Former Friends</span>
                    <label for="former-friends-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" value="" id="former-friends-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <button id="deep-search-btn" class="custom-button bg-blue-500 hover:bg-blue-600 w-44 h-12 flex items-center justify-center gap-2 shadow-lg">
                    <i class="fas fa-sitemap"></i>
                    <span>Deep Search</span>
                </button>
            </div>
            <!-- MODIFIED: Icon Changed -->
            <button id="fab-main-btn" class="custom-button rounded-full w-16 h-16 flex items-center justify-center text-2xl bg-white shadow-lg transform transition-transform duration-300 ease-in-out">
                <i class="fas fa-cog"></i>
            </button>
        </div>

        <script>
            const SERVERLESS_URL = 'https://saikou-ban-proxy.saikoudevelopment.workers.dev';

            document.addEventListener('DOMContentLoaded', () => {
                const addUserToLookup = (user) => {
                    const userId = user.name || user.id.toString();
                    if (!seedUsers.has(userId)) {
                        seedUsers.add(userId);
                        renderSeedUsers();
                        userInput.focus();
                        return true;
                    }
                    return false;
                };
                const userInput = document.getElementById('user-input');
                const addUserBtn = document.getElementById('add-user-btn');
                const seedUsersContainer = document.getElementById('seed-users-container');
                const generateGraphBtn = document.getElementById('generate-graph-btn');
                const graphContainer = document.getElementById('graph-container');
                const svg = d3.select("#graph-svg");
                const tooltip = d3.select("#graph-tooltip");
                const placeholder = document.getElementById('graph-placeholder');
                const graphLegend = document.getElementById('graph-legend');
                const filterLegend = document.getElementById('filter-legend');
                const profileModal = document.getElementById('profile-modal');
                const modalContent = document.getElementById('modal-content');
                const loadingModal = document.getElementById('loading-modal');
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                const nodeSearch = document.getElementById('node-search');
                const fabContainer = document.getElementById('fab-container');
                const fabMainBtn = document.getElementById('fab-main-btn');
                const deepSearchBtn = document.getElementById('deep-search-btn');
                const formerFriendsToggle = document.getElementById('former-friends-toggle');
                
                nodeSearch.disabled = false;
                
                // MODIFIED: Simplified show/hide controls
                const showControls = () => {
                    document.querySelector('.search-container').style.display = 'block';
                    document.getElementById('graph-legend').style.display = 'block';
                    nodeSearch.focus();
                };
                
                const hideControls = () => {
                    document.querySelector('.search-container').style.display = 'none';
                    document.getElementById('graph-legend').style.display = 'none';
                };
                
                let seedUsers = new Set();
                let simulation = d3.forceSimulation();

                // --- Event Listeners ---
                addUserBtn.addEventListener('click', addSeedUser);
                userInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addSeedUser(); }});
                generateGraphBtn.addEventListener('click', () => generateGraph(false));
                deepSearchBtn.addEventListener('click', () => generateGraph(true));
                fabMainBtn.addEventListener('click', () => fabContainer.classList.toggle('open'));
                formerFriendsToggle.addEventListener('change', (e) => {
                    document.getElementById('graph-svg').classList.toggle('show-former-links', e.target.checked);
                    renderLegend(e.target.checked);
                });
                seedUsersContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('remove-user-btn')) {
                        seedUsers.delete(e.target.dataset.user);
                        renderSeedUsers();
                    }
                });
                 profileModal.addEventListener('click', (e) => {
                    if (e.target.id === 'profile-modal' || e.target.id === 'close-modal-btn') {
                        hideProfileModal();
                    }
                });
                
                filterLegend.addEventListener('change', filterNodes);

                // Store the current search term
                let currentSearchTerm = '';

                // Function to apply search highlighting
                const applySearchHighlight = () => {
                    const allNodes = d3.selectAll('.node');
                    
                    if (!currentSearchTerm) {
                        allNodes.classed('searched', false);
                        allNodes.select('.search-highlight').style('opacity', 0);
                        return;
                    }
                    
                    allNodes.each(function(d) {
                        const node = d3.select(this);
                        const nodeName = (d.name || '').toLowerCase();
                        const nodeId = d.id ? d.id.toString() : '';
                        const displayName = (d.displayName || '').toLowerCase();
                        
                        const matches = nodeName.includes(currentSearchTerm) || 
                                     nodeId.includes(currentSearchTerm) ||
                                     displayName.includes(currentSearchTerm);
                        
                        node.classed('searched', matches);
                        node.select('.search-highlight')
                            .style('opacity', matches ? 0.3 : 0)
                            .style('fill', '#3b82f6');
                    });
                };

                // Update the search event listener
                nodeSearch.addEventListener('input', (e) => {
                    currentSearchTerm = e.target.value.trim().toLowerCase();
                    applySearchHighlight();
                });

                function addSeedUser() {
                    const query = userInput.value.trim();
                    if (!query || seedUsers.has(query)) {
                        userInput.value = '';
                        return;
                    }
                    seedUsers.add(query);
                    renderSeedUsers();
                    userInput.value = '';
                    userInput.focus();
                };

                function renderSeedUsers() {
                    seedUsersContainer.innerHTML = '';
                    seedUsers.forEach(user => {
                        const userEl = document.createElement('div');
                        userEl.className = 'bg-gray-700 text-white text-sm font-semibold px-3 py-1 rounded-full flex items-center gap-2';
                        userEl.innerHTML = `<span>${user}</span><button data-user="${user}" class="remove-user-btn text-gray-400 hover:text-white">&times;</button>`;
                        seedUsersContainer.appendChild(userEl);
                    });
                };

                const showLoadingModal = (show, text = 'Initializing...', progress = 0) => {
                    if (show) {
                        progressText.textContent = text;
                        progressBar.style.width = `${progress}%`;
                        loadingModal.classList.remove('hidden');
                        setTimeout(() => loadingModal.style.opacity = '1', 10);
                    } else {
                        loadingModal.style.opacity = '0';
                        setTimeout(() => loadingModal.classList.add('hidden'), 300);
                    }
                };
                
                // MODIFIED: Legends are now left-justified
                const renderLegend = (showFormer) => {
                     graphLegend.innerHTML = `
                        <div class="legend-title">Node Outline</div>
                        <div class="flex items-center justify-start w-full mb-1">
                            <div class="w-3 h-3 rounded-sm border-2 mr-2" style="border-color: #10b981;"></div>
                            <span class="text-xs text-gray-300">Staff</span>
                        </div>
                        <div class="flex items-center justify-start w-full mb-1">
                            <div class="w-3 h-3 rounded-sm border-2 mr-2" style="border-color: #ef4444;"></div>
                            <span class="text-xs text-gray-300">Banned/Terminated</span>
                        </div>
                        <div class="flex items-center justify-start w-full mb-1">
                            <div class="w-3 h-3 rounded-sm border-2 mr-2" style="border-color: #f59e0b;"></div>
                            <span class="text-xs text-gray-300">New Account (&lt;90d)</span>
                        </div>
                        <div class="flex items-center justify-start w-full mb-1">
                            <div class="w-3 h-3 rounded-sm border-2 mr-2" style="border-color: #6b7280;"></div>
                            <span class="text-xs text-gray-300">Normal User</span>
                        </div>

                        <div class="legend-title mt-3">Node Highlight</div>
                        <div class="flex items-center justify-start w-full mb-1">
                            <div class="w-3 h-3 rounded-sm mr-2" style="background-color: #f59e0b;"></div>
                            <span class="text-xs text-gray-300">Seed User</span>
                        </div>
                        <div class="flex items-center justify-start w-full mb-1">
                            <div class="w-3 h-3 rounded-sm mr-2" style="background-color: #3b82f6;"></div>
                            <span class="text-xs text-gray-300">Searched User</span>
                        </div>

                        ${showFormer ? `
                        <div class="legend-title mt-3">Links</div>
                        <div class="flex items-center justify-start w-full">
                            <div class="w-4 h-0 border-t-2 border-dashed mr-2" style="border-color: #f87171;"></div>
                            <span class="text-xs text-gray-300">Former Friend</span>
                        </div>` : ''}
                     `;
                }
                
                const getNodeType = (d) => {
                    if (d.groupRole) {
                        const lowerRole = d.groupRole.toLowerCase();
                        if (lowerRole.includes('developer') || lowerRole.includes('manager') || lowerRole.includes('moderator') || lowerRole.includes('contractor')) {
                            return 'staff';
                        }
                    }
                    if (d.isBanned || d.isTerminated) return 'banned';
                    if (d.created !== null) {
                         const ageMs = Date.now() - new Date(d.created).getTime();
                         if (ageMs / (1000 * 60 * 60 * 24) < 90) return 'new';
                    }
                    return 'normal';
                };

                function filterNodes() {
                    const activeFilters = new Set();
                    document.querySelectorAll('.filter-checkbox:checked').forEach(cb => {
                        activeFilters.add(cb.dataset.filter);
                    });

                    const visibleNodeIds = new Set();

                    svg.selectAll('.node').each(function(d) {
                        const nodeElement = d3.select(this);
                        const type = getNodeType(d);
                        const isSeedUser = seedUsers.has(d.id?.toString()) || seedUsers.has(d.name);
                        const isVisible = isSeedUser || activeFilters.has(type);
                        nodeElement.style('display', isVisible ? null : 'none');
                        if (isVisible) {
                            visibleNodeIds.add(d.id);
                        }
                    });

                    svg.selectAll('.link').style('display', d => {
                        const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                        const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                        return (visibleNodeIds.has(sourceId) && visibleNodeIds.has(targetId)) ? null : 'none';
                    });
                }

                async function generateGraph(isDeepSearch = false) {
                    if (seedUsers.size === 0) {
                        alert("Please add at least one user to generate the graph.");
                        return;
                    }

                    placeholder.style.display = 'none';
                    showControls();
                    fabContainer.classList.remove('open');
                    svg.selectAll("*").remove();
                    showLoadingModal(true, 'Finding initial users & checking cache...', 10);
                    
                    try {
                        const usersParam = Array.from(seedUsers).join(',');
                        
                        const response = await fetch(`${SERVERLESS_URL}/graph`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ users: usersParam, deep: isDeepSearch })
                        });

                        const data = await response.json();

                        if (!response.ok || data.success === false) throw new Error(data.error || 'Failed to fetch graph data.');
                        if (data.nodes.length === 0) throw new Error("No users found or no connections could be established.");

                        showLoadingModal(true, 'Building visualization...', 90);
                        renderGraph(data);
                        renderLegend(formerFriendsToggle.checked);
                        showLoadingModal(false);

                    } catch (error) {
                        console.error('Graph Generation Error:', error);
                        let errorMessage = error.message;
                        if (errorMessage.includes("Too many subrequests")) {
                            errorMessage = "The request was too large and hit a server limit. Please try a smaller number of initial users or use the regular search instead of Deep Search.";
                        }
                        placeholder.textContent = `Error: ${errorMessage}`;
                        placeholder.style.display = 'flex';
                        hideControls();
                        showLoadingModal(false);
                    }
                };
                
                const getNodeColor = (node) => {
                    const type = getNodeType(node);
                    switch(type) {
                        case 'staff': return '#10b981';
                        case 'banned': return '#ef4444';
                        case 'new': return '#f59e0b';
                        default: return '#6b7280';
                    }
                };

                function renderGraph({ nodes, links }) {
                    const width = graphContainer.clientWidth;
                    const height = graphContainer.clientHeight;
                    const g = svg.append("g"); 

                    simulation.stop();
                    
                    simulation = d3.forceSimulation(nodes)
                        .force("link", d3.forceLink(links).id(d => d.id).distance(80).strength(0.8))
                        .force("charge", d3.forceManyBody().strength(-350))
                        .force("center", d3.forceCenter(width / 2, height / 2))
                        .force("collide", d3.forceCollide().radius(16));

                    const link = g.append("g")
                        .selectAll("line")
                        .data(links)
                        .join("line")
                        .attr("class", "link")
                        .classed("former-link", d => d.isFormer);

                    const nodeGroup = g.append("g")
                        .selectAll("g")
                        .data(nodes)
                        .join("g")
                        .attr("class", d => {
                            let classes = "node";
                            const isSeedUser = seedUsers.has(d.name) || seedUsers.has(d.id?.toString());
                            if (isSeedUser) {
                                classes += " seed-user";
                            }
                            return classes;
                        })
                        .attr("id", d => `node-${d.id}`)
                        .style("opacity", 1); // All nodes fully visible by default
                    
                    const defs = svg.append('defs');
                    nodeGroup.each(function(d) {
                        defs.append('pattern')
                            .attr('id', `avatar-${d.id}`).attr('height', '100%').attr('width', '100%').attr('patternContentUnits', 'objectBoundingBox')
                            .append('image').attr('href', d.avatarUrl).attr('height', 1).attr('width', 1).attr('preserveAspectRatio', 'xMidYMid slice');
                    });

                    nodeGroup.append("circle")
                        .attr("r", 15)
                        .attr("class", "search-highlight");

                    nodeGroup.append("circle")
                        .attr("r", 15)
                        .attr("class", "node-background")
                        .attr("stroke", d => getNodeColor(d));

                    nodeGroup.append("circle")
                        .attr("r", 13)
                        .attr("fill", d => `url(#avatar-${d.id})`);
                    
                    nodeGroup
                        .call(drag(simulation))
                        .on("click", (event, d) => { 
                            event.stopPropagation(); 
                            showProfileModal(d); 
                        })
                        .on('mouseover', function(event, d) {
                            tooltip.style("opacity", 1)
                                .html(`<p class="font-bold text-sm">${d.displayName || d.name || 'Unknown'}</p><p class="text-xs text-gray-400">${d.name ? `@${d.name}` : `(ID: ${d.id})`}</p>`);

                            const connectedNodes = new Set([d.id]);
                            links.forEach(l => {
                                if (l.source.id === d.id) connectedNodes.add(l.target.id);
                                if (l.target.id === d.id) connectedNodes.add(l.source.id);
                            });

                            nodeGroup.classed('hovered', n => connectedNodes.has(n.id));
                            
                            // Only dim non-connected, non-seed users
                            nodeGroup.style('opacity', n => {
                                const isConnected = connectedNodes.has(n.id);
                                const isSeed = seedUsers.has(n.name) || seedUsers.has(n.id?.toString());
                                return (isConnected || isSeed) ? 1 : 0.3;
                            });
                            
                            link.style('stroke-opacity', l => (l.source.id === d.id || l.target.id === d.id) ? 1.0 : 0.05);

                            // Only update stroke for non-seed users
                            const isSeed = seedUsers.has(d.name) || seedUsers.has(d.id?.toString());
                            if (!isSeed) {
                                d3.select(this).select('.node-background')
                                    .style('stroke', '#a5b4fc')
                                    .style('stroke-width', 4);
                            }
                        })
                        .on("mousemove", (event) => {
                            const rect = graphContainer.getBoundingClientRect();
                            tooltip.style("left", (event.clientX - rect.left + 15) + "px").style("top", (event.clientY - rect.top) + "px");
                        })
                        .on('mouseout', function() {
                            tooltip.style("opacity", 0);
                            nodeGroup.classed('hovered', false);
                            // Reset all nodes to full opacity on mouseout
                            nodeGroup.style('opacity', 1);
                            link.style('stroke-opacity', 0.6);
                        });


                    simulation.on("tick", () => {
                        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                        nodeGroup.attr("transform", d => `translate(${d.x}, ${d.y})`);
                        
                        // Ensure seed users are always fully visible
                        nodeGroup.each(function(d) {
                            const isSeed = seedUsers.has(d.name) || seedUsers.has(d.id?.toString());
                            if (isSeed) {
                                d3.select(this).style("opacity", 1);
                            }
                        });
                    });
                    
                    filterNodes();

                    applySearchHighlight();

                    svg.call(d3.zoom().scaleExtent([0.1, 4]).on('zoom', (event) => g.attr('transform', event.transform))).on("dblclick.zoom", null);
                }

                function drag(simulation) {
                    return d3.drag()
                        .on("start", (event, d) => { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
                        .on("drag", (event, d) => { d.fx = event.x; d.fy = event.y; })
                        .on("end", (event, d) => { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; });
                }

                function showProfileModal(d) {
                    const createdText = d.isTerminated ? '[Terminated]' : d.created ? new Date(d.created).toLocaleDateString() : 'Join Date Private';
                    const banReasonHtml = d.isBanned ? `<div class="mt-3 bg-red-900/50 p-2 rounded-md text-center"><p class="text-sm font-semibold text-red-300">BANNED</p><p class="text-xs text-red-400 mt-1">${d.banReason || 'No reason provided.'}</p></div>` : '';
                    const cacheDateHtml = d.cacheTimestamp ? `<div class="mt-2 text-center text-xs text-gray-500">Cache Updated: ${new Date(d.cacheTimestamp).toLocaleString()}</div>` : '';

                    modalContent.innerHTML = `
                        <div class="flex items-center">
                            <img src="${d.avatarUrl}" class="w-16 h-16 rounded-full mr-4 border-2" style="border-color: ${getNodeColor(d)}">
                            <div>
                                <p class="font-bold text-lg">${d.displayName || d.name || 'Unknown'}</p>
                                <p class="text-sm text-gray-400">${d.name ? `@${d.name}` : `(ID: ${d.id})`}</p>
                            </div>
                        </div>
                        ${banReasonHtml}
                        <div class="mt-2 text-xs text-gray-500 text-center">Joined: ${createdText}</div>
                        <a href="./lookup.html?lookup=${d.id}" target="_blank" class="block w-full text-center custom-button mt-4">View Full Profile</a>
                        <button id="add-to-map-btn" class="block w-full text-center custom-button bg-blue-600 hover:bg-blue-700 mt-2" data-user-id="${d.id}">
                            ${seedUsers.has(d.name || d.id.toString()) ? 'Already in map' : 'Add to map'}
                        </button>
                        ${cacheDateHtml}
                        <button id="close-modal-btn" class="block w-full text-center custom-button bg-gray-600 hover:bg-gray-700 mt-2">Close</button>
                    `;
                    profileModal.classList.remove('hidden');
                    
                    const addToMapBtn = document.getElementById('add-to-map-btn');
                    if (addToMapBtn) {
                        if (seedUsers.has(d.name || d.id.toString())) {
                            addToMapBtn.disabled = true;
                            addToMapBtn.classList.add('bg-gray-500', 'cursor-default');
                        } else {
                            addToMapBtn.addEventListener('click', () => {
                                const added = addUserToLookup(d);
                                if (added) {
                                    addToMapBtn.textContent = 'Added to map!';
                                    addToMapBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                                    addToMapBtn.classList.add('bg-green-600', 'cursor-default');
                                    addToMapBtn.disabled = true;
                                }
                            });
                        }
                    }
                }
                
                function hideProfileModal() {
                    profileModal.classList.add('hidden');
                }
            });
        </script>
	</body>
</html>
