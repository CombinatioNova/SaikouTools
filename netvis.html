<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0 viewport-fit=cover" />
		<title>Saikou | Friend Connection Graph</title>
		<meta name="description" content="Visualize the network of friends between Roblox users for moderation and investigation." />
		<link rel="icon" type="image/png" href="https://saikou.dev/assets/images/favicon.png" onerror="this.onerror=null;this.href='https://placehold.co/32x32/121315/FFFFFF?text=S'" />

		<!-- Tailwind CSS -->
		<script src="https://cdn.tailwindcss.com"></script>

		<!-- D3.js for Graph Visualization -->
		<script src="https://d3js.org/d3.v7.min.js"></script>

		<!-- Fonts & Icons -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" xintegrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

		<style>
			body {
				font-family: 'Montserrat', sans-serif;
				background-color: #121315;
				color: white;
                overflow-y: auto;
			}
			input {
				background-color: #1f222c;
				border: 1px solid #353a4a;
				color: white;
				border-radius: 0.5rem;
				padding: 0.75rem;
                transition: border-color 0.3s ease;
			}
            input:focus {
                outline: none;
                border-color: #7f89ff;
            }
			.custom-button {
				font-weight: bold;
				border-radius: 0.5rem;
				color: #121315;
				background-color: #ffffff;
                padding: 0.75rem 1.5rem;
				opacity: 1;
				transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.3s ease;
                cursor: pointer;
			}
			.custom-button:hover:not(:disabled) {
				opacity: 0.8;
			}
            .custom-button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .graph-container {
                width: 100%;
                height: calc(100vh - 220px);
                position: relative;
                background-color: #15171c;
                border-radius: 0.5rem;
                overflow: hidden;
                margin: 1rem 0;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
            #graph-svg {
                width: 100%;
                height: 100%;
            }
            .node, .link {
                transition: opacity 0.3s ease, stroke-opacity 0.3s ease;
            }
            .node circle {
                stroke-width: 3px;
                transition: stroke 0.3s ease, stroke-width 0.3s ease;
            }
            .link {
                stroke: #4b5563; /* Gray-600 */
                stroke-opacity: 0.6;
            }
            .link.former-link {
                stroke: #f87171; /* Red-400 */
                stroke-dasharray: 4;
                stroke-opacity: 0; /* Hidden by default */
                transition: stroke-opacity 0.3s;
            }
            #graph-svg.show-former-links .link.former-link {
                 stroke-opacity: 0.5; /* Visible when toggled */
            }
            .tooltip {
                position: absolute;
                background-color: rgba(12, 13, 14, 0.95);
                border: 1px solid #4b5563;
                border-radius: 0.5rem;
                padding: 0.5rem 0.75rem;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.1s;
                z-index: 10;
                transform: translate(15px, -50%);
                white-space: nowrap;
                max-width: none;
            }
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 50;
                transition: opacity 0.3s ease;
            }
            .modal-content {
                background-color: #1f222c;
                padding: 1.5rem;
                border-radius: 0.5rem;
                width: 90%;
                max-width: 350px;
                border: 1px solid #353a4a;
            }
            .progress-bar-container {
                width: 100%;
                background-color: #374151;
                border-radius: 9999px;
                height: 0.75rem;
            }
            .progress-bar {
                background-color: #4ade80;
                height: 0.75rem;
                border-radius: 9999px;
                transition: width 0.5s ease-out;
            }
            .graph-legend {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background-color: rgba(12, 13, 14, 0.8);
                padding: 0.5rem 0.75rem;
                border-radius: 0.5rem;
                border: 1px solid #353a4a;
                z-index: 5;
            }
            /* FAB Styling */
            #fab-container.open #fab-actions {
                transform: scale(1) translateY(0);
                opacity: 1;
                pointer-events: auto;
            }
            #fab-container.open #fab-main-btn {
                transform: rotate(45deg);
                background-color: #d1d5db; /* Lighter gray when open */
            }
		</style>
	</head>
	<body class="bg-[#121315]">
		<!-- Header -->
		<header class="container mx-auto px-4 md:px-0">
			<nav class="max-w-7xl mx-auto my-4 p-4 bg-[#0c0d0e] rounded-lg flex items-center justify-between">
				<a class="flex items-center" href="/index.html">
					<span class="text-white font-bold text-xl">[SDIS] Department of Institutional Security</span>
				</a>
			</nav>
		</header>

		<!-- Main Content -->
		<main class="container mx-auto px-4">
            <div class="max-w-7xl mx-auto">
                <div class="text-center">
                    <h1 class="text-4xl md:text-5xl font-bold">Personal Network Visualizer</h1>
                    <p class="mt-4 text-lg text-gray-300">Visualize the friend network between multiple Roblox users.</p>
                </div>

                <div class="mt-8 bg-[#1f222c] p-4 rounded-lg shadow-lg">
                    <div class="flex flex-col sm:flex-row gap-4 items-end">
                        <div class="flex-grow">
                            <label for="user-input" class="block text-sm font-medium text-gray-400 mb-1">Add Users by Username or ID</label>
                            <div class="flex gap-2">
                                <input type="text" id="user-input" class="w-full" placeholder="Enter username or ID...">
                                <button id="add-user-btn" class="custom-button">Add</button>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                             <button id="generate-graph-btn" class="custom-button bg-green-500 hover:bg-green-600 w-full sm:w-auto">Generate Graph</button>
                        </div>
                    </div>
                     <div id="seed-users-container" class="mt-3 flex flex-wrap gap-2"></div>
                </div>

                <!-- Graph Display -->
                <div id="graph-container" class="graph-container mt-4">
                    <div id="graph-tooltip" class="tooltip"></div>
                    <svg id="graph-svg"></svg>
                     <div id="graph-legend" class="graph-legend hidden"></div>
                    <div id="graph-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500">
                        <p>Add users above and click "Generate Graph" to begin.</p>
                    </div>
                </div>
            </div>
		</main>

        <!-- Modals -->
        <div id="profile-modal" class="modal-overlay hidden">
            <div id="modal-content" class="modal-content"></div>
        </div>
        <div id="loading-modal" class="modal-overlay hidden opacity-0">
             <div class="modal-content text-center">
                <h3 class="text-lg font-bold">Building Graph</h3>
                <div class="progress-bar-container mt-4">
                    <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-sm text-gray-400 mt-2">Initializing...</p>
             </div>
        </div>

        <!-- Floating Action Button -->
        <div id="fab-container" class="fixed bottom-6 right-6 z-30 flex flex-col items-center gap-3">
            <div id="fab-actions" class="flex flex-col items-center gap-3 transition-all duration-300 ease-in-out transform scale-90 opacity-0 -translate-y-4 pointer-events-none">
                <div class="flex items-center justify-center gap-2 bg-[#1f222c] p-2 rounded-lg shadow-lg w-44">
                    <span class="text-xs font-semibold text-gray-300">Show Former Friends</span>
                    <label for="former-friends-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" value="" id="former-friends-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <button id="deep-search-btn" class="custom-button bg-blue-500 hover:bg-blue-600 w-44 h-12 flex items-center justify-center gap-2 shadow-lg">
                    <i class="fas fa-sitemap"></i>
                    <span>Deep Search</span>
                </button>
            </div>
            <button id="fab-main-btn" class="custom-button rounded-full w-16 h-16 flex items-center justify-center text-2xl bg-white shadow-lg transform transition-transform duration-300 ease-in-out">
                <i class="fas fa-tools"></i>
            </button>
        </div>

        <script>
            const SERVERLESS_URL = 'https://saikou-ban-proxy.saikoudevelopment.workers.dev';

            document.addEventListener('DOMContentLoaded', () => {
                // Function to add a user to the lookup list
                const addUserToLookup = (user) => {
                    const userId = user.name || user.id.toString();
                    if (!seedUsers.has(userId)) {
                        seedUsers.add(userId);
                        renderSeedUsers();
                        userInput.focus();
                        return true;
                    }
                    return false;
                };
                const userInput = document.getElementById('user-input');
                const addUserBtn = document.getElementById('add-user-btn');
                const seedUsersContainer = document.getElementById('seed-users-container');
                const generateGraphBtn = document.getElementById('generate-graph-btn');
                const graphContainer = document.getElementById('graph-container');
                const svg = d3.select("#graph-svg");
                const tooltip = d3.select("#graph-tooltip");
                const placeholder = document.getElementById('graph-placeholder');
                const graphLegend = document.getElementById('graph-legend');
                const profileModal = document.getElementById('profile-modal');
                const modalContent = document.getElementById('modal-content');
                const loadingModal = document.getElementById('loading-modal');
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                
                // FAB Elements
                const fabContainer = document.getElementById('fab-container');
                const fabMainBtn = document.getElementById('fab-main-btn');
                const deepSearchBtn = document.getElementById('deep-search-btn');
                const formerFriendsToggle = document.getElementById('former-friends-toggle');

                let seedUsers = new Set();
                let simulation = d3.forceSimulation();

                // --- Event Listeners ---
                addUserBtn.addEventListener('click', addSeedUser);
                userInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); addSeedUser(); }});
                generateGraphBtn.addEventListener('click', () => generateGraph(false));
                deepSearchBtn.addEventListener('click', () => generateGraph(true));
                fabMainBtn.addEventListener('click', () => fabContainer.classList.toggle('open'));
                formerFriendsToggle.addEventListener('change', (e) => {
                    document.getElementById('graph-svg').classList.toggle('show-former-links', e.target.checked);
                    renderLegend(e.target.checked);
                });
                seedUsersContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('remove-user-btn')) {
                        seedUsers.delete(e.target.dataset.user);
                        renderSeedUsers();
                    }
                });
                 profileModal.addEventListener('click', (e) => {
                    if (e.target.id === 'profile-modal' || e.target.id === 'close-modal-btn') {
                        hideProfileModal();
                    }
                });

                // --- UI Functions ---
                function addSeedUser() {
                    const query = userInput.value.trim();
                    if (!query || seedUsers.has(query)) {
                        userInput.value = '';
                        return;
                    }
                    seedUsers.add(query);
                    renderSeedUsers();
                    userInput.value = '';
                    userInput.focus();
                };

                function renderSeedUsers() {
                    seedUsersContainer.innerHTML = '';
                    seedUsers.forEach(user => {
                        const userEl = document.createElement('div');
                        userEl.className = 'bg-gray-700 text-white text-sm font-semibold px-3 py-1 rounded-full flex items-center gap-2';
                        userEl.innerHTML = `<span>${user}</span><button data-user="${user}" class="remove-user-btn text-gray-400 hover:text-white">&times;</button>`;
                        seedUsersContainer.appendChild(userEl);
                    });
                };

                const showLoadingModal = (show, text = 'Initializing...', progress = 0) => {
                    if (show) {
                        progressText.textContent = text;
                        progressBar.style.width = `${progress}%`;
                        loadingModal.classList.remove('hidden');
                        setTimeout(() => loadingModal.style.opacity = '1', 10);
                    } else {
                        loadingModal.style.opacity = '0';
                        setTimeout(() => loadingModal.classList.add('hidden'), 300);
                    }
                };

                const renderLegend = (showFormer) => {
                     graphLegend.innerHTML = `
                        <div class="flex items-center mb-1"><div class="w-3 h-3 rounded-sm border-2 mr-2" style="border-color: #10b981;"></div><span class="text-xs">Staff</span></div>
                        <div class="flex items-center mb-1"><div class="w-3 h-3 rounded-sm border-2 mr-2" style="border-color: #ef4444;"></div><span class="text-xs">Banned/Terminated</span></div>
                        <div class="flex items-center mb-1"><div class="w-3 h-3 rounded-sm border-2 mr-2" style="border-color: #f59e0b;"></div><span class="text-xs">New Account (&lt;90d)</span></div>
                        <div class="flex items-center mb-1"><div class="w-3 h-3 rounded-sm border-2 mr-2" style="border-color: #6b7280;"></div><span class="text-xs">Normal User</span></div>
                        ${showFormer ? `<div class="flex items-center"><div class="w-3 h-0 border-t-2 border-dashed mr-2" style="border-color: #f87171;"></div><span class="text-xs">Former Friend</span></div>` : ''}
                     `;
                }

                // --- Graph Generation ---
                const generateGraph = async (isDeepSearch = false) => {
                    if (seedUsers.size === 0) {
                        alert("Please add at least one user to generate the graph.");
                        return;
                    }

                    placeholder.classList.add('hidden');
                    graphLegend.classList.add('hidden');
                    fabContainer.classList.remove('open');
                    svg.selectAll("*").remove();
                    showLoadingModal(true, 'Finding initial users & checking cache...', 10);
                    
                    try {
                        const usersParam = Array.from(seedUsers).join(',');
                        
                        const response = await fetch(`${SERVERLESS_URL}/graph`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ users: usersParam, deep: isDeepSearch })
                        });

                        const data = await response.json();

                        if (!response.ok || data.success === false) throw new Error(data.error || 'Failed to fetch graph data.');
                        if (data.nodes.length === 0) throw new Error("No users found or no connections could be established.");

                        showLoadingModal(true, 'Building visualization...', 90);
                        renderGraph(data);
                        renderLegend(formerFriendsToggle.checked);
                        graphLegend.classList.remove('hidden');
                        showLoadingModal(false);

                    } catch (error) {
                        console.error('Graph Generation Error:', error);
                        let errorMessage = error.message;
                        if (errorMessage.includes("Too many subrequests")) {
                            errorMessage = "The request was too large and hit a server limit. Please try a smaller number of initial users or use the regular search instead of Deep Search.";
                        }
                        placeholder.textContent = `Error: ${errorMessage}`;
                        placeholder.classList.remove('hidden');
                        showLoadingModal(false);
                    }
                };
                
                const getNodeColor = (node) => {
                    if (node.groupRole) {
                        const lowerRole = node.groupRole.toLowerCase();
                        if (lowerRole.includes('developer') || lowerRole.includes('manager') || lowerRole.includes('moderator') || lowerRole.includes('contractor')) {
                            return '#10b981';
                        }
                    }
                    if (node.isBanned || node.isTerminated) return '#ef4444';
                    if (node.created === null) return '#6b7280';
                    const ageMs = Date.now() - new Date(node.created).getTime();
                    if (ageMs / (1000 * 60 * 60 * 24) < 90) return '#f59e0b';
                    return '#6b7280';
                };

                function renderGraph({ nodes, links }) {
                    const width = graphContainer.clientWidth;
                    const height = graphContainer.clientHeight;
                    const g = svg.append("g"); 

                    simulation.stop();
                    
                    simulation = d3.forceSimulation(nodes)
                        .force("link", d3.forceLink(links).id(d => d.id).distance(80).strength(0.8))
                        .force("charge", d3.forceManyBody().strength(-350))
                        .force("center", d3.forceCenter(width / 2, height / 2))
                        .force("collide", d3.forceCollide().radius(16)); // Add collision to prevent overlap

                    const link = g.append("g")
                        .selectAll("line")
                        .data(links)
                        .join("line")
                        .attr("class", "link")
                        .classed("former-link", d => d.isFormer);

                    const nodeGroup = g.append("g")
                        .selectAll("g")
                        .data(nodes)
                        .join("g")
                        .attr("class", "node");
                    
                    const defs = svg.append('defs');
                    nodeGroup.each(function(d) {
                        defs.append('pattern')
                            .attr('id', `avatar-${d.id}`).attr('height', '100%').attr('width', '100%').attr('patternContentUnits', 'objectBoundingBox')
                            .append('image').attr('href', d.avatarUrl).attr('height', 1).attr('width', 1).attr('preserveAspectRatio', 'xMidYMid slice');
                    });

                    nodeGroup.append("circle").attr("r", 15).attr("fill", d => `url(#avatar-${d.id})`).attr("stroke", d => getNodeColor(d));
                    
                    // --- Event Handlers for Highlighting and Interaction ---
                    nodeGroup
                        .call(drag(simulation))
                        .on("click", (event, d) => { 
                            event.stopPropagation(); 
                            showProfileModal(d); 
                        })
                        .on('mouseover', function(event, d) {
                            tooltip.style("opacity", 1)
                                .html(`<p class="font-bold text-sm">${d.displayName || d.name || 'Unknown'}</p><p class="text-xs text-gray-400">${d.name ? `@${d.name}` : `(ID: ${d.id})`}</p>`);

                            const connectedNodes = new Set([d.id]);
                            links.forEach(l => {
                                if (l.source.id === d.id) connectedNodes.add(l.target.id);
                                if (l.target.id === d.id) connectedNodes.add(l.source.id);
                            });

                            nodeGroup.style('opacity', n => connectedNodes.has(n.id) ? 1.0 : 0.15);
                            link.style('stroke-opacity', l => (l.source.id === d.id || l.target.id === d.id) ? 1.0 : 0.05);

                            d3.select(this).select('circle').style('stroke', '#a5b4fc').style('stroke-width', 4);
                        })
                        .on("mousemove", (event) => {
                            const rect = graphContainer.getBoundingClientRect();
                            tooltip.style("left", (event.clientX - rect.left + 15) + "px").style("top", (event.clientY - rect.top) + "px");
                        })
                        .on('mouseout', function(event, d) {
                            tooltip.style("opacity", 0);

                            nodeGroup.style('opacity', 1);
                            link.style('stroke-opacity', l => {
                                if (l.isFormer) {
                                    return formerFriendsToggle.checked ? 0.5 : 0;
                                }
                                return 0.6;
                            });

                            d3.select(this).select('circle')
                                .style('stroke', getNodeColor(d))
                                .style('stroke-width', 3);
                        });


                    simulation.on("tick", () => {
                        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                        nodeGroup.attr("transform", d => `translate(${d.x}, ${d.y})`);
                    });
                    
                    svg.call(d3.zoom().scaleExtent([0.1, 4]).on('zoom', (event) => g.attr('transform', event.transform))).on("dblclick.zoom", null);
                }

                function drag(simulation) {
                    return d3.drag()
                        .on("start", (event, d) => { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
                        .on("drag", (event, d) => { d.fx = event.x; d.fy = event.y; })
                        .on("end", (event, d) => { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; });
                }

                function showProfileModal(d) {
                    const createdText = d.isTerminated ? '[Terminated]' : d.created ? new Date(d.created).toLocaleDateString() : 'Join Date Private';
                    const banReasonHtml = d.isBanned ? `<div class="mt-3 bg-red-900/50 p-2 rounded-md text-center"><p class="text-sm font-semibold text-red-300">BANNED</p><p class="text-xs text-red-400 mt-1">${d.banReason || 'No reason provided.'}</p></div>` : '';
                    const cacheDateHtml = d.cacheTimestamp ? `<div class="mt-2 text-center text-xs text-gray-500">Cache Updated: ${new Date(d.cacheTimestamp).toLocaleString()}</div>` : '';

                    modalContent.innerHTML = `
                        <div class="flex items-center">
                            <img src="${d.avatarUrl}" class="w-16 h-16 rounded-full mr-4 border-2" style="border-color: ${getNodeColor(d)}">
                            <div>
                                <p class="font-bold text-lg">${d.displayName || d.name || 'Unknown'}</p>
                                <p class="text-sm text-gray-400">${d.name ? `@${d.name}` : `(ID: ${d.id})`}</p>
                            </div>
                        </div>
                        ${banReasonHtml}
                        <div class="mt-2 text-xs text-gray-500 text-center">Joined: ${createdText}</div>
                        <a href="./lookup.html?lookup=${d.id}" target="_blank" class="block w-full text-center custom-button mt-4">View Full Profile</a>
                        <button id="add-to-map-btn" class="block w-full text-center custom-button bg-blue-600 hover:bg-blue-700 mt-2" data-user-id="${d.id}">
                            ${seedUsers.has(d.name || d.id.toString()) ? 'Already in map' : 'Add to map'}
                        </button>
                        ${cacheDateHtml}
                        <button id="close-modal-btn" class="block w-full text-center custom-button bg-gray-600 hover:bg-gray-700 mt-2">Close</button>
                    `;
                    profileModal.classList.remove('hidden');
                    
                    // Add event listener for the Add to Map button
                    const addToMapBtn = document.getElementById('add-to-map-btn');
                    if (addToMapBtn) {
                        if (seedUsers.has(d.name || d.id.toString())) {
                            addToMapBtn.disabled = true;
                            addToMapBtn.classList.add('bg-gray-500', 'cursor-default');
                        } else {
                            addToMapBtn.addEventListener('click', () => {
                                const added = addUserToLookup(d);
                                if (added) {
                                    addToMapBtn.textContent = 'Added to map!';
                                    addToMapBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                                    addToMapBtn.classList.add('bg-green-600', 'cursor-default');
                                    addToMapBtn.disabled = true;
                                }
                            });
                        }
                    }
                }
                
                function hideProfileModal() {
                    profileModal.classList.add('hidden');
                }
            });
        </script>
	</body>
</html>


